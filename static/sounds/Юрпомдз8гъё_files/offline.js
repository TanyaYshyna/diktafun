(function(g){var window=this;'use strict';var opZ=function(L){const m=new g.Xr("und",new g.t3("Default","und",!0));m.captionTracks=L.captionTracks;return m},chJ=function(L){return new g.Hh(function(m,n){let C=L.length;
const Z=[];if(C){var z=function(X,N){C--;Z[X]=N;C==0&&m(Z)},v=function(X){n(X)};
for(let X=0;X<L.length;X++){var E=L[X];g.jJ(E,g.IU(z,X),v)}}else m(Z)})},LJf=function({type:L,
payload:m}){L={type:L};m!==void 0&&(L.payload=m);return L},RV=function(L){L=L.key||L.id;
if(!L)throw Error("Entity key is missing");return L},m4z=function(){if(w4)return w4();
w4=g.rC("PersistentEntityStoreDb",{K2:{EntityStore:{HW:1},EntityAssociationStore:{HW:2}},shared:!1,upgrade(L,m){m(1)&&g.Ih(g.eB(L,"EntityStore",{keyPath:"key"}),"entityType","entityType");m(2)&&(L=g.eB(L,"EntityAssociationStore",{keyPath:["parentEntityKey","childEntityKey"]}),g.Ih(L,"byParentEntityKey","parentEntityKey"),g.Ih(L,"byChildEntityKey","childEntityKey"))},version:3});return w4()},nqf=function(L){return g.U$(m4z(),L)},ee=function(L){return g.U$((0,g.L4m)(),L)},CFz=function(L){return L instanceof
Error?new g4("UNKNOWN_ENCODE_ERROR",{originalMessage:L.message}):new g4("UNKNOWN_ENCODE_ERROR")},Zm$=function(L){return L instanceof Error?new g4("UNKNOWN_DECODE_ERROR",{originalMessage:L.message}):new g4("UNKNOWN_DECODE_ERROR")},zOr=function(L,m){L=L instanceof g4?L:m(L);
g.CP(L);throw L;},vqF=function(L,m,n){try{return L.J(m,n)}catch(C){zOr(C,CFz)}},MS=function(L){L=(new TextEncoder).encode(L).subarray(0,16);
const m=new Uint8Array(16);m.set(L);return m},X0F=function(L){const m=Eq$[L];
if(m)return m;g.ZE(new g.WN("Entity model not found.",{entityType:L}))},IV=function(L,m){a:{L=Se(L.O,m.version);
try{var n=L.O(m.data,m.key);break a}catch(C){zOr(C,Zm$)}n=void 0}return n},Jv=function(L,m,n){return L.W.objectStore("EntityStore").get(m).then(C=>{if(C){if(n&&C.entityType!==n)throw Error("Incorrect entity type");
return IV(L,C)}})},Av=function(L,m,n){return n?(n=n.map(C=>Jv(L,C,m)),g.ah.all(n)):L.W.objectStore("EntityStore").index("entityType").getAll(IDBKeyRange.only(m)).then(C=>C.map(Z=>IV(L,Z)))},Trr=function(L,m,n){const C=RV(m);
return bG(L,C).then(()=>Nr$(L,m,n))},tv=function(L,m,n){let C=L.J[n];
C||(C=new Set,L.J[n]=C);C.add(m)},fo=function(L,m,n){const C=RV(m),Z=Se(L.O,1),z={...m};
return L.W.objectStore("EntityStore").get(C).then(v=>{if(v){if(v.entityType!==n)throw Error("Incorrect entity type");z.entityMetadata||(v=IV(L,v),z.entityMetadata=v.entityMetadata)}}).then(()=>{const v={key:C,
entityType:n,data:vqF(Z,z,C),version:1};return g.ah.all([g.MX(L.W.objectStore("EntityStore"),v),Trr(L,z,n)])}).then(()=>{tv(L,C,n);
return C})},Ua=function(L,m,n){m=m.map(C=>fo(L,C,n));
return g.ah.all(m)},imH=function(L,m,n){if(n.has(m))return g.ah.resolve(void 0);
n.add(m);return VyZ(L,m).then(C=>L.W.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(m)).then(()=>C)).then(C=>{let Z=g.ah.resolve(void 0);
for(const z of C)Z=Z.then(()=>imH(L,z,n));
return Z}).then(()=>{})},Bs=function(L,m,n){if(n?.uD){const Z=new Set;
return imH(L,m,Z).then(()=>{const z=[];for(const v of Z)z.push(Bs(L,v));return g.ah.all(z).then(()=>{})})}const C=g.XW(m).entityType;
return g.ah.all([L.W.objectStore("EntityStore").delete(m),bG(L,m)]).then(()=>{tv(L,m,C)})},bG=function(L,m){return L.W.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(m))},Ps=function(L,m){return g.tt(L.W.objectStore("EntityStore").index("entityType"),{query:IDBKeyRange.only(m)},n=>g.ah.all([n.delete(),
bG(L,n.cursor.primaryKey)]).then(()=>{tv(L,n.cursor.primaryKey,m);return g.bd(n)}))},$4l=function(L,m,n,C){const Z=Se(L.O,1);
return Jv(L,m,C).then(z=>{if(z){z=g.Jc(z,n);var v={key:m,entityType:C,data:vqF(Z,z,m),version:1};return g.ah.all([g.MX(L.W.objectStore("EntityStore"),v),Trr(L,z,C)])}}).then(()=>{tv(L,m,C);
return m})},Nr$=function(L,m,n){const C=RV(m);
n=X0F(n);if(!n)return g.ah.resolve([]);m=new n(m);L=L.W.objectStore("EntityAssociationStore");n=[];for(const Z of m.O())n.push(g.MX(L,{parentEntityKey:C,childEntityKey:Z}));return g.ah.all(n).then(Z=>Z.map(z=>z[1]))},VyZ=function(L,m){const n=L.W.objectStore("EntityAssociationStore");
return n.index("byParentEntityKey").getAll(IDBKeyRange.only(m)).then(C=>{const Z=[];for(const z of C)Z.push(n.index("byChildEntityKey").getAll(z.childEntityKey));return g.ah.all(Z)}).then(C=>{const Z=[];
for(const z of C)z.length===1&&Z.push(z[0].childEntityKey);return Z})},Se=function(L,m=0){L=L.W[m];
if(!L)throw m=new g4("INVALID_ENCODER_VERSION",{NZ:m}),g.CP(m),m;return L},aap=function(L,m){for(const n of L.observers)n(m)},sa=async function(L,m,n){var C=await nqf(L.token);
let Z;m=await g.wC(C,["EntityStore","EntityAssociationStore"],m,z=>{Z=new qYD(z,L.W);return n(Z)});
Z&&(C=Z.J,Object.keys(C).length>0&&(L.channel.postMessage(C),aap(L,C)));return m},Qo=function(L,m,n){return sa(L,{mode:"readwrite",
HD:!0},C=>fo(C,m,n))},D4J=function(L,m){return sa(L,{mode:"readwrite",
HD:!0},n=>Ua(n,m,"offlineOrchestrationActionWrapperEntity"))},po=function(L,m){return sa(L,{mode:"readwrite",
HD:!0},n=>Bs(n,m))},Om_=function(L){return sa(L,{mode:"readwrite",
HD:!0},m=>Ps(m,"videoPlaybackPositionEntity"))},F5=function(L,m,n){return sa(L,{mode:"readonly",
HD:!0},C=>Jv(C,m,n))},uG=function(L,m,n){return sa(L,{mode:"readonly",
HD:!0},C=>Av(C,m,n))},w00=async function(){try{const m=await g.ht();
if(m&&g.Yf()&&typeof g.X8.BroadcastChannel!=="undefined"){var L=new laD;return new ROo(m,L)}}catch(m){m instanceof Error&&g.CP(m)}},r4=function(){hv||(hv=w00());
return hv},eOH=function(L){L=L.options?.persistenceOption;
return L==="ENTITY_PERSISTENCE_OPTION_PERSIST"||L==="ENTITY_PERSISTENCE_OPTION_INMEMORY_AND_PERSIST"},gqz=async function(L){const m=await r4();
m&&await sa(m,"readwrite",n=>{const C={};for(const Z of L){if(!Z.entityKey||!eOH(Z))continue;const z=g.Pz(Z.payload);let v=void 0;Z.type==="ENTITY_MUTATION_TYPE_REPLACE"&&(v=()=>fo(n,Z.payload[z],z));
Z.type==="ENTITY_MUTATION_TYPE_DELETE"&&(v=()=>Bs(n,Z.entityKey));
Z.type==="ENTITY_MUTATION_TYPE_UPDATE"&&(v=()=>$4l(n,Z.entityKey,Z.payload[z],z));
v&&(C[Z.entityKey]=C[Z.entityKey]?C[Z.entityKey].then(v):v())}return g.ah.all(Object.values(C))})},kM=async function(L){!(L=L.mutations)||L.length<=0||(g.Y1&&g.Y1.dispatch(LJf({type:"ENTITY_LOADED",
payload:L})),await gqz(L),L.length=0)},Myp=function(L){return L!==void 0},SYr=function(L){var m=g.gh();
m=Object.assign({},m);L=Object.assign({},L);for(const n in m)L[n]?(m[n]!==4&&(m[n]=L[n]),delete L[n]):m[n]!==2&&(m[n]=4);Object.assign(m,L);g.gbx(m);JSON.stringify(m);return m},Ia_=async function(L){const m=await g.ht();
return m?g.wC(await g.Iz(m),["index","media","captions"],{mode:"readwrite",HD:!0},n=>{const C=IDBKeyRange.bound(L+"|",L+"~");n=[n.objectStore("index").delete(C),n.objectStore("media").delete(C),n.objectStore("captions").delete(C)];return g.ah.all(n).then(()=>{})}):void 0},JVr=async function(){const L=await g.ht();
if(!L)throw g.$F("rvdfd");return g.wC(await g.Iz(L),["index","media"],{mode:"readwrite",HD:!0},m=>{const n={};return g.At(m.objectStore("index"),{},C=>{var Z=C.cursor.key.match(/^([\w\-_]+)\|(a|v)$/);let z=g.ah.resolve(void 0);if(Z){const v=Z[1];Z=Z[2];n[v]=n[v]||{};n[v][Z]=g.Jca(C.getValue()?.fmts)}else z=C.delete().then(()=>{});
return g.ah.all([g.bd(C),z]).then(([v])=>v)}).then(()=>{const C={};
for(const z of Object.keys(n)){const v=n[z].v;C[z]=n[z].a&&v?1:2}const Z=SYr(C);return g.ERZ(m.objectStore("media"),{},z=>{const v=z.cursor.key.match(g.fw2);v&&C[v[1]]||m.objectStore("media").delete(z.cursor.key);return g.cnP(z)}).then(()=>Z)})})},AV0=async function(L,m){var n=await g.ht();
if(!n)throw g.$F("wct");n=await g.Iz(n);await g.wC(n,["captions"],{mode:"readwrite",HD:!0},C=>{const Z=[];C=C.objectStore("captions");for(let z=0;z<m.length;z++){const v=g.MX(C,m[z],L+"|"+m[z].metadata.vss_id);Z.push(v)}return g.ah.all(Z)})},bm$=async function(L){L=IDBKeyRange.bound(L+"|",L+"~");
const m=await g.ht();if(!m)throw g.$F("gactfv");return(await g.Iz(m)).getAll("captions",L)},ty_=async function(L){g.ST(L,0);
return Ia_(L)},faJ=function(L){return{context:g.fI(),
videoIds:L}},U4p=function(L){return{context:g.fI(),
playlistIds:L}},Br$=function(L){return{context:g.fI(),
offlinePlaylistSyncChecks:L}},sL0=function(){Hs||(Hs=new PF$);
return Hs},QLJ=function(L,m){return{eventType:{flowEventNamespace:"FLOW_EVENT_NAMESPACE_OFFLINE_ORCHESTRATION",
flowEventType:L},metadata:m,statusCode:void 0,csn:void 0,can:void 0}},p00=function(L,m,n){n||(n=L.W.get("FLOW_TYPE_OFFLINE_ORCHESTRATION"),n||(n=g.dN(16),L.W.set("FLOW_TYPE_OFFLINE_ORCHESTRATION",n)));
L={flowNonce:n,flowType:"FLOW_TYPE_OFFLINE_ORCHESTRATION",flowEventType:m.eventType};m.metadata&&(L.flowMetadata=m.metadata);m.statusCode!==void 0&&(L.flowEventStatus=m.statusCode);m.csn&&(L.csn=m.csn);m.can&&(L.can=m.can);g.mR("flowEvent",L,void 0)},FJr=async function(L){var m=await sa(L,{mode:"readonly",
HD:!0},D=>Av(D,"playbackData").then(R=>{var I=R.map(Q=>Q.transfer).filter(Q=>!!Q),t=R.map(Q=>Q.offlineVideoPolicy).filter(Q=>!!Q),f=R.filter(Q=>!!Q.key).map(Q=>g.N6(g.XW(Q.key).entityId,"downloadStatusEntity"));
I=Av(D,"transfer",I);t=Av(D,"offlineVideoPolicy",t);f=Av(D,"downloadStatusEntity",f);const p=I.then(Q=>{Q=Q.reduce((r,d)=>{d?.offlineVideoStreams&&r.push(...d.offlineVideoStreams);return r},[]).filter(r=>!!r);
return Av(D,"offlineVideoStreams",Q)});
return g.ah.all([I,t,p,f]).then(([Q,r,d,DF])=>[R,Q,r,d,DF])}));
L=await sa(L,{mode:"readonly",HD:!0},D=>Av(D,"mainDownloadsListEntity").then(R=>R[0]?.downloads??[]));
const [n,C,Z,z,v]=m,E={},X={},N={},T={},V={};m=[];for(var a of C)a&&(E[a.key]=a);for(const D of Z)D&&(X[D.key]=D);for(const D of v)D&&(N[D.key]=D);for(const D of z)D&&(T[D.key]=D);for(const D of L)V[D.videoItem??""]=!0,D.videoItem&&(a=g.XW(D.videoItem)?.entityId??"",m.push({externalVideoId:a}));return{offlineVideos:n.filter(D=>{if(!D||!D.key||!D.offlineVideoPolicy)return!1;D=g.XW(D.key).entityId;D=g.N6(D,"downloadStatusEntity");return!(D&&N[D]?.downloadState==="DOWNLOAD_STATE_USER_DELETED")}).map(D=>
{var R=E[D.transfer];
const I=[];if(R?.offlineVideoStreams)for(var t of R.offlineVideoStreams){var f=T[t];f&&I.push(f)}t=X[D.offlineVideoPolicy];f=D?.playerResponseTimestamp;var p=g.XW(t.key).entityId;D=g.N6(p,"mainVideoEntity");if(t.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"){var Q="OFFLINE_VIDEO_STATE_DISABLED";t.expirationTimestamp&&Number(t.expirationTimestamp)<Date.now()/1E3&&(Q="OFFLINE_VIDEO_STATE_EXPIRED")}else if(t.action==="OFFLINE_VIDEO_POLICY_ACTION_DOWNLOAD_FAILED")Q="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";
else{switch(R?.transferState){case "TRANSFER_STATE_TRANSFER_IN_QUEUE":Q="OFFLINE_VIDEO_STATE_PENDING";break;case "TRANSFER_STATE_TRANSFERRING":Q="OFFLINE_VIDEO_STATE_TRANSFERRING";break;case "TRANSFER_STATE_PAUSED_BY_USER":Q="OFFLINE_VIDEO_STATE_PAUSED_TRANSFER";break;case "TRANSFER_STATE_FAILED":Q="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";break;case "TRANSFER_STATE_COMPLETE":Q="OFFLINE_VIDEO_STATE_PLAYABLE";break;case "TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH":Q="OFFLINE_VIDEO_STATE_STREAMS_OUT_OF_DATE";
break;default:Q="OFFLINE_VIDEO_STATE_UNKNOWN"}if(Q==="OFFLINE_VIDEO_STATE_OFFLINE_FAILED")switch(R?.failureReason){case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":Q="OFFLINE_VIDEO_STATE_OUT_OF_STORAGE_ERROR";break;case "TRANSFER_FAILURE_REASON_STREAM_MISSING":Q="OFFLINE_VIDEO_STATE_STREAMS_MISSING";break;case "TRANSFER_FAILURE_REASON_NETWORK":case "TRANSFER_FAILURE_REASON_NETWORK_LOST":Q="OFFLINE_VIDEO_STATE_NETWORK_ERROR"}}p={id:p,videoState:Q};
R?.cotn&&(p.cotn=R.cotn);R?.maximumDownloadQuality&&(p.selectedVideoQuality=R?.maximumDownloadQuality);R?.lastProgressTimeMs&&(p.lastProgressTimeMs=R.lastProgressTimeMs);f&&(p.playerResponseSavedTimeMs=String(Number(f)*1E3));R=String;f=0;for(const r of I)if(r.streamsProgress)for(const d of r.streamsProgress)f+=Number(d.numBytesDownloaded??0);p.downloadedBytes=R(f);p.selectedOfflineMode=V[D]?"OFFLINE_MODE_TYPE_AUTO_OFFLINE":"OFFLINE_NOW";t.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"&&(p.offlinePlaybackDisabledReason=
t.offlinePlaybackDisabledReason);return p}),
additionalOfflineClientState:{mainAppAdditionalOfflineClientState:{smartDownloadVideos:m}}}},hOF=function(){try{let n=g.$P("ytglobal.locks_");
if(n)return n;var L;if(L=navigator){var m=navigator;L="locks"in m&&!!m.locks}if(L)return g.X8.localStorage&&g.X8.localStorage.getItem("noop"),n=new uEr,g.V2("ytglobal.locks_",n),n}catch{}},YM=function(L){if(L.includes(":"))throw Error(`Invalid user cache name: ${L}`);
return`${L}:${g.HN("CacheStorage get")}`},rVr=async function(){return Ws!==void 0?Ws:Ws=new Promise(async L=>{try{await G_.open("test-only"),await G_.delete("test-only")}catch(m){if(m instanceof Error&&m.name==="SecurityError"){L(!1);
return}}L("caches"in window)})},Ko=async function(){if(await rVr())return d4||(d4=new kB$),d4},xM=function(L,m,n){g.ZE(new g.WN(`Woffle: ${L}`,n?{cotn:n}:""));
m instanceof Error&&g.ZE(m)},HmD=async function(L){L=await FJr(L);
g.mR("offlineStateSnapshot",L)},yo=function(L,m){g.Pv(L.api,"onOfflineOperationFailure",m);
L.W?.postMessage(m)},YYH=function(L){if(!L.J&&!L.W){var m=hOF();
if(m){L.J=!0;var n=g.HN("OfflineLockManager");m.request(`${"woffle_orchestration_leader"}:${n}`,{},async()=>{try{L.O=new g.lz,L.W=!0,L.J=!1,await L.T(),await L.O.promise}catch(C){L.DX(),C instanceof Error&&(C.args=[{name:"WoLockManagerError",iI:C.name}],g.CP(C))}})}}},je=function(L){L.S&&L.U&&L.L&&L.visibility.isBackground()?L.G.h8(6E4):L.G.stop()},WJD=function(L){L.W&&(L.L=!0,je(L))},GB0=function(L,m){L.W&&(L.U=m,je(L))},d4$=function(L,m){L.W&&(L.S=m,je(L))},oV=function(L){L.offlineDeleteReason=
L.offlineDeleteReason??"OFFLINE_DELETE_REASON_UNKNOWN";
L.offlineModeType=L.offlineModeType??"OFFLINE_NOW";g.mR("offlineDeleteEvent",L)},cs=function(L,{videoId:m,
QZ:n,offlineModeType:C}){L.encryptedVideoId=m;L.cotn=n?.cotn;L.offlineabilityFormatType=n?.maximumDownloadQuality;L.isRefresh=n?.isRefresh??!1;L.softErrorCount=n?.transferRetryCount??0;L.offlineModeType=C??"OFFLINE_NOW";(L.transferStatusType==="TRANSFER_STATUS_TYPE_UNKNOWN"&&L.statusType==="UNKNOWN_STATUS_TYPE"||!L.transferStatusType&&!L.statusType)&&g.ZE(Error("Woffle unknown transfer status"));g.mR("offlineTransferStatusChanged",L)},KJp=function(L,m,n,C){C={transferStatusType:"TRANSFER_STATUS_TYPE_PROCESSING",
statusType:"OFFLINING_STARTED",transferFirstStarted:!!C};m&&n&&(m=Math.floor(m/1024).toFixed(),n=Math.floor(n/1024).toFixed(),C.alreadyDownloadedKbytes=m,C.totalFetchedKbytes=m,C.totalContentKbytes=n);cs(C,L)},x4w=function(L){cs({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_USER_PAUSE",
statusType:"SUSPENDED"},L)},yVF=function(L){switch(L){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":return"OFFLINE_DATABASE_ERROR";
case "TRANSFER_FAILURE_REASON_PLAYABILITY":return"NOT_PLAYABLE";case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":return"TOO_MANY_RETRIES";case "TRANSFER_FAILURE_REASON_INTERNAL":return"OFFLINE_DOWNLOAD_CONTROLLER_ERROR";case "TRANSFER_FAILURE_REASON_STREAM_MISSING":return"STREAM_VERIFICATION_FAILED";case "TRANSFER_FAILURE_REASON_SERVER":case "TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING":return"OFFLINE_REQUEST_FAILURE";case "TRANSFER_FAILURE_REASON_NETWORK":return"OFFLINE_NETWORK_ERROR";default:return"UNKNOWN_FAILURE_REASON"}},
LE=function(L){return(L.actionMetadata?.retryScheduleIntervalsInSeconds?.length??0)>0},m0=function(L){return L.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD"&&!!L.entityKey},nE=function(L){return L.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&!!L.entityKey},CE=function(L){return L.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&!!L.entityKey},jLw=function(L){return L.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE"&&!!L.entityKey},Zs=async function(L,m,n,C,Z=!1){const z=
g.N6(L,m),v=g.N6(L,"downloadStatusEntity");
L=await sa(n,{mode:"readonly",HD:!0},X=>g.ah.all([Jv(X,z,m),Jv(X,v,"downloadStatusEntity")]));
const E=L.length?L[0]:void 0;if(E){let X=L.length>1?L[1]:void 0;if(X){if(X.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&!Z)return;X.downloadState=C}else X={key:v,downloadState:C};g.N5(E,oqo,X);await sa(n,{mode:"readwrite",HD:!0},N=>g.ah.all([fo(N,E,m),fo(N,X,"downloadStatusEntity")]))}},zM=function(L,m){return L.actionType===m.actionType&&L.entityKey===m.entityKey},vw=function(L,m){if(L&&L.transferState!=="TRANSFER_STATE_COMPLETE"&&L.transferState!=="TRANSFER_STATE_FAILED"){const n=g.XW(L.key).entityId;
cs({transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_BY_USER",statusType:"CANCELLED"},{videoId:n,QZ:L,offlineModeType:m})}},EN=function(L){if(!L||!L.thumbnails)return[];
const m=[];for(const n of L.thumbnails)n.url&&m.push(n.url);return m},Xz=async function(L,m,n=[]){if(!n.length)return[];
m=await uG(L,m);L=new Set;for(var C of m)if(m=C.id||C.key)m=g.XW(m).entityId,L.add(m);C=[];for(const Z of n)n=Z.offlineVideoData,n?.videoId&&!L.has(n.videoId)&&C.push(Z);return C},N0=function(L,m,n){return new g.BV(L,{cotn:m,
raw_player_response:n,download_media:!0,start:Infinity,disable_watch_next:!0})},TM=function(){return{priority:1,
retryScheduleIntervalsInSeconds:[1,2,4]}},i1=function(L){if(!L.key)throw Error("Entity key is required.");
if(!L.actionProto)throw Error("OfflineOrchestrationAction is required.");const m=g.XW(L.key),n=g.XW(L.actionProto.entityKey);return new VV(n.entityType,m.entityId,L.actionProto,L.parentActionId,L.rootActionId,L.childActionIds,L.prereqActionId,L.postreqActionIds,L.retryScheduleIndex,L.hasChildActionFailed,Number(L.enqueueTimeSec)*1E3)},$$=function(L){return{key:g.N6(L.actionId,"offlineOrchestrationActionWrapperEntity"),
actionProto:L.action,parentActionId:L.parentActionId,rootActionId:L.rootActionId,childActionIds:L.childActionIds,prereqActionId:L.prereqActionId,postreqActionIds:L.postreqActionIds,retryScheduleIndex:L.retryScheduleIndex,hasChildActionFailed:L.hasChildActionFailed,enqueueTimeSec:(L.W/1E3).toFixed()}},cVH=async function(){const L=await Ko();
return L?L.delete("yt-player-local-img"):!0},a2=async function(L){const m=await Ko();
if(!m)throw Error("Cache API not supported");if(L.length){var n=await m.open("yt-player-local-img");await Promise.all(L.map(C=>n.delete(C)))}},q0=async function(L){const m=await Ko();
if(!m)throw Error("Cache API not supported");L.length&&await (await m.open("yt-player-local-img")).addAll(L)},Ds=async function(L,m,n,C,Z){const z=g.N6(L,"mainVideoEntity"),v=g.N6(L,"ytMainChannelEntity"),E=g.N6(L,"transfer"),X=g.N6(L,"videoDownloadContextEntity");
var N=await sa(m,{mode:"readonly",HD:!0},Q=>g.ah.all([Jv(Q,z,"mainVideoEntity"),Jv(Q,v,"ytMainChannelEntity"),Jv(Q,E,"transfer"),Jv(Q,X,"videoDownloadContextEntity"),Av(Q,"ytMainChannelEntity"),Av(Q,"offlineOrchestrationActionWrapperEntity")]));
const [T,V,a,D,R,I]=N;if(T||V){N=T?EN(T.thumbnail):[];var t=V?await L5D(V,R):[];await a2(N.concat(t))}const f=[],p=g.N6(L,"downloadStatusEntity");for(const Q of I)N=g.XW(Q.key).entityId,t=i1(Q),t=g.XW(t.action.entityKey).entityId,N!==L&&t!==L||zM(n,Q.actionProto)||f.push(Q.key);await sa(m,{mode:"readwrite",HD:!0},Q=>{const r=f.map(d=>Bs(Q,d));
r.push(Bs(Q,z,{uD:!0}));r.push(Bs(Q,p,{uD:!0}));return g.ah.all(r)});
L=D?.offlineModeType;Z&&(oV(Z),Z.offlineModeType&&(L=Z.offlineModeType));vw(a,L);yo(C,{entityKey:z,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},ON=async function(L,m,n,C){const Z=g.N6(L,"mainPlaylistEntity"),z=g.N6(L,"ytMainChannelEntity");
var v=await sa(m,{mode:"readonly",HD:!0},Q=>g.ah.all([Jv(Q,Z,"mainPlaylistEntity"),Jv(Q,z,"ytMainChannelEntity"),Av(Q,"mainPlaylistEntity"),Av(Q,"mainDownloadsListEntity"),Av(Q,"ytMainChannelEntity"),Av(Q,"offlineOrchestrationActionWrapperEntity")]));
const [E,X,N,T,V,a]=v;if(E||X){v=E?mNH(E):[];var D=X?await L5D(X,V):[];await a2(v.concat(D))}v=[];D=new Map;if(E){v=await n8_(E,N,T);for(var R of v)D.set(R,{videoId:R,playlistId:L,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});R=await sa(m,{mode:"readonly",HD:!0},d=>g.ah.all([Av(d,"transfer"),Av(d,"videoDownloadContextEntity")]));
const [Q,r]=R;for(var I of Q)R=g.XW(I.key).entityId,(R=D.get(R))&&I&&(R.cotn=I.cotn);for(var t of r)I=g.XW(t.key).entityId,(I=D.get(I))&&t&&(I.offlineModeType=t.offlineModeType)}const f=[];for(const Q of a)t=g.XW(Q.key).entityId,I=i1(Q),t!==L&&I.rootActionId!==L||zM(n,Q.actionProto)||f.push(Q.key);const p=g.N6(L,"mainPlaylistEntity");await sa(m,{mode:"readwrite",HD:!0},Q=>{const r=f.map(d=>Bs(Q,d));
r.push(Bs(Q,p,{uD:!0}));return g.ah.all(r)});
if(E&&(v.reverse(),v))for(const Q of v)await Ds(Q,m,n,C,D.get(Q))},l1=async function(L,m,n,C){const Z=g.N6("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),z=new Map;
L=await sa(L,{mode:"readwrite",HD:!0},v=>{const E=Av(v,"transfer"),X=Av(v,"offlineOrchestrationActionWrapperEntity"),N=Av(v,"videoDownloadContextEntity"),T=Jv(v,Z,"mainDownloadsListEntity");return g.ah.all([E,X,N,T]).then(([V,a,D,R])=>{const I=Cur.map(t=>Ps(v,t));
for(const t of a)zM(m,t.actionProto)||I.push(Bs(v,t.key,{uD:!0}));R&&(R.downloads=[],I.push(fo(v,R,"mainDownloadsListEntity")));if(D)for(const t of D)a=g.XW(t.key).entityId,a=g.N6(a,"transfer"),z.set(a,t.offlineModeType);return g.ah.all(I).then(()=>V)})});
for(const v of L){vw(v,z.get(v.key));L=g.XW(v.key).entityId;const E={videoId:L,offlineDeleteReason:C,cotn:v.cotn,offlineModeType:z.get(v.key)};oV(E);L=g.N6(L,"mainVideoEntity");yo(n,{entityKey:L,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})}await cVH()},mNH=function(L,m){let n=[];
if(L.thumbnailStyleData)for(const C of L.thumbnailStyleData)n=n.concat(EN(C?.value?.collageThumbnail?.coverThumbnail));L=EN(m);return n.concat(L)},n8_=async function(L,m,n){const C=[],Z=new Set;
if(n.length)for(var z of n)if(z.downloads?.length)for(const v of z.downloads)v.videoItem&&(n=g.XW(v.videoItem).entityId,Z.add(n));if(L.videos){for(const v of L.videos)z=JSON.parse(g.XW(v).entityId),z.videoId&&!Z.has(z.videoId)&&C.push(z.videoId);for(const v of m)if(v.key!==L.key&&(m=v.videos))for(const E of m)m=JSON.parse(g.XW(E).entityId),m.videoId&&(m=C.indexOf(m.videoId),m!==-1&&C.splice(m,1))}return C},L5D=async function(L,m){const n=EN(L.avatar);
for(const C of m)if(C.id!==L.id)for(const Z of EN(C.avatar))m=n.indexOf(Z),m!==-1&&n.splice(m,1);return n},Z6w=async function(L){const m=g.F(L.frameworkUpdates,R2);
L.frameworkUpdates&&m&&await kM(m)},v8z=function(L){if(L.onResponseReceivedActions?.length&&(L=g.F(g.F(L.onResponseReceivedActions[0],z3F),g.ppZ)?.actions,L?.length))return L},E80=async function(L){if(!L)return[];
L=await F5(L,g.Kg,"mainDownloadsListEntity");return L?.downloads?.length?L.downloads.map(m=>m.videoItem??""):[]},wk=async function(L,m){const n=await XT_(L,m);
n&&await sa(L,{mode:"readwrite",HD:!0},C=>{const Z=[fo(C,n.mainDownloadsLibraryEntity,"mainDownloadsLibraryEntity")];n.mainDownloadsListEntity&&Z.push(fo(C,n.mainDownloadsListEntity,"mainDownloadsListEntity"));return g.ah.all(Z)})},XT_=async function(L,m){const n=g.N6("main_downloads_library_id","mainDownloadsLibraryEntity"),C=g.N6("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
L=await sa(L,{mode:"readonly",HD:!0},X=>g.ah.all([Jv(X,n,"mainDownloadsLibraryEntity"),Jv(X,C,"mainDownloadsListEntity")]));
let [Z,z]=L;L=Z;let v=z;L||(L={id:n});for(const X of m)if(X===g.Kg){if(L.smartDownloadsList)return;L.smartDownloadsList=X}else{var E=g.XW(X).entityType;m={};E==="mainPlaylistEntity"?m.playlistItem=X:E==="mainVideoEntity"&&(m.videoItem=X);if(!g.Y_(m)){if(v?.downloads){E=!1;for(const N of v.downloads)if(N.playlistItem===X||N.videoItem===X){E=!0;break}E||v.downloads.push(m)}else v={id:C,downloads:[m]};L.downloadsList=C}}return{mainDownloadsLibraryEntity:L,mainDownloadsListEntity:v}},ej=async function(L,
m){const n=g.N6("main_downloads_library_id","mainDownloadsLibraryEntity"),C=g.N6("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
var Z=await sa(L,{mode:"readonly",HD:!0},X=>g.ah.all([Jv(X,n,"mainDownloadsLibraryEntity"),Jv(X,C,"mainDownloadsListEntity"),Jv(X,g.Kg,"mainDownloadsListEntity")]));
const [z,v,E]=Z;if(z){if(m===g.Kg&&E?.downloads)E.downloads=[];else if(v?.downloads){Z=g.XW(m).entityType;for(let X=0;X<v.downloads.length;X++){const N=v.downloads[X];if(Z==="mainVideoEntity"&&N.videoItem===m){v.downloads.splice(X,1);break}else if(Z==="mainPlaylistEntity"&&N.playlistItem===m){v.downloads.splice(X,1);break}}}await sa(L,{mode:"readwrite",HD:!0},X=>{const N=[fo(X,z,"mainDownloadsLibraryEntity")];v&&N.push(fo(X,v,"mainDownloadsListEntity"));E&&N.push(fo(X,E,"mainDownloadsListEntity"));
return g.ah.all(N)})}},gk=async function(L,m){const n=g.N6(m,"transfer"),C=g.N6(m,"videoDownloadContextEntity");
L=await sa(L,{mode:"readonly",HD:!0},v=>g.ah.all([Jv(v,n,"transfer"),Jv(v,C,"videoDownloadContextEntity")]));
const [Z,z]=L;return{videoId:m,cotn:Z?.cotn,offlineModeType:z?.offlineModeType}},M0=async function(L,m,n,C,Z){const z=g.N6(L,"musicTrack"),v=g.N6(L,"transfer");
var E=await sa(m,{mode:"readonly",HD:!0},R=>g.ah.all([Jv(R,z,"musicTrack"),Jv(R,v,"transfer"),Av(R,"musicTrack"),Av(R,"offlineOrchestrationActionWrapperEntity")]));
const [X,N,T,V]=E;X&&(E=await NEH(X,T),await a2(E));const a=[];for(const R of V){E=g.XW(R.key).entityId;var D=i1(R);D=g.XW(D.action.entityKey).entityId;E!==L&&D!==L||zM(n,R.actionProto)||a.push(R.key)}await sa(m,{mode:"readwrite",HD:!0},R=>{const I=a.map(t=>Bs(R,t));
I.push(Bs(R,z,{uD:!0}));return g.ah.all(I)});
vw(N);Z&&oV(Z);yo(C,{entityKey:z,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},Sj=async function(L,m,n,C,Z){const z=g.N6(L,m),v=g.N6("music_downloads_library_id","musicDownloadsLibraryEntity");
var E=await sa(n,{mode:"readonly",HD:!0},f=>g.ah.all([Jv(f,z,m),Jv(f,v,"musicDownloadsLibraryEntity"),Av(f,m),Av(f,"offlineOrchestrationActionWrapperEntity")]));
const [X,N,T,V]=E;X&&(E=await NEH(X,T),await a2(E));let a=[];E=new Map;if(X){a=await TE_(X,T,N);for(var D of a){const f=g.XW(D).entityId;E.set(f,{videoId:f,playlistId:L,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"})}D=await uG(n,"transfer");for(var R of D)D=g.XW(R.key).entityId,(D=E.get(D))&&R&&(D.cotn=R.cotn)}const I=[];for(const f of V)R=g.XW(f.key).entityId,D=i1(f),R!==L&&D.rootActionId!==L||zM(C,f.actionProto)||I.push(f.key);const t=g.N6(L,m);await sa(n,{mode:"readwrite",HD:!0},
f=>{const p=I.map(Q=>Bs(f,Q));
p.push(Bs(f,t,{uD:!0}));return g.ah.all(p)});
if(X&&(a.reverse(),a.length))for(const f of a)(L=g.XW(f).entityId)&&await M0(L,n,C,Z,E.get(L))},I2=async function(L,m,n){L=await sa(L,{mode:"readwrite",
HD:!0},C=>{const Z=Av(C,"transfer"),z=Av(C,"offlineOrchestrationActionWrapperEntity");return g.ah.all([Z,z]).then(([v,E])=>{const X=VHp.map(N=>Ps(C,N));
for(const N of E){E=g.XW(N.actionProto.entityKey).entityType==="musicTrack";const T=N.actionProto.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD";zM(m,N.actionProto)||E&&(!E||T)||X.push(Bs(C,N.key,{uD:!0}))}return g.ah.all(X).then(()=>v)})});
for(const C of L)vw(C),L=g.XW(C.key).entityId,oV({videoId:L,offlineDeleteReason:void 0,cotn:C.cotn}),L=g.N6(L,"musicTrack"),yo(n,{entityKey:L,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"});await cVH()},i6$=function(L){let m;
for(const n of L.additionalMetadatas)n.offlineMusicVideoData&&(m=n.offlineMusicVideoData);return{id:g.N6(L.videoId,"musicTrack"),videoId:L.videoId,title:L.title,thumbnailDetails:L.thumbnail,lengthMs:String(Number(L.lengthSeconds)*1E3),albumTitle:m?.releaseTitle,musicVideoType:m?.musicVideoType,contentRating:{explicitType:m?.explicitType},artistNames:m?.byline||m?.channelName,downloadMetadata:g.N6(L.videoId,"musicTrackDownloadMetadataEntity")}},TE_=async function(L,m,n){const C=[],Z=new Set;
if(n?.downloadedTracks?.length)for(const z of n.downloadedTracks)Z.add(z);if(L.tracks){for(const z of L.tracks)Z.has(z)||C.push(z);for(const z of m)if(z.id!==L.id&&(m=z.tracks))for(const v of m)m=C.indexOf(v),m!==-1&&C.splice(m,1)}return C},NEH=async function(L,m){const n=EN(L.thumbnailDetails);
for(const C of m)if(C.id!==L.id)for(const Z of EN(C.thumbnailDetails))m=n.indexOf(Z),m!==-1&&n.splice(m,1);return n},Je=async function(L,m){var n=g.N6("music_downloads_library_id","musicDownloadsLibraryEntity");
let C=await F5(L,n,"musicDownloadsLibraryEntity");C||(C={id:n});n=g.XW(m).entityType;n==="musicTrack"?C.downloadedTracks?.includes(m)||(C.downloadedTracks=(C.downloadedTracks??[]).concat(m)):n==="musicPlaylist"?C.downloadedPlaylists?.includes(m)||(C.downloadedPlaylists=(C.downloadedPlaylists??[]).concat(m)):n!=="musicAlbumRelease"||C.downloadedAlbumReleases?.includes(m)||(C.downloadedAlbumReleases=(C.downloadedAlbumReleases??[]).concat(m));await Qo(L,C,"musicDownloadsLibraryEntity")},Ae=async function(L,
m){var n=g.N6("music_downloads_library_id","musicDownloadsLibraryEntity");
if(n=await F5(L,n,"musicDownloadsLibraryEntity")){var C=g.XW(m).entityType;let Z;C==="musicTrack"?Z=n.downloadedTracks:C==="musicPlaylist"&&(Z=n.downloadedPlaylists);if(Z?.length)for(C=0;C<Z.length;C++)if(Z[C]===m){Z.splice(C,1);break}await Qo(L,n,"musicDownloadsLibraryEntity")}},$Nw=function(L){var m=L.videos;
L=[];const n=[];if(m)for(const Z of m){var C=Z.offlineVideoData.videoId;m=g.N6(C,"musicTrack");C=g.N6(C,"musicTrackDownloadMetadataEntity");L.push(m);n.push(C)}return{TU:L,Qq:n}},b1=function(L,m,n){m={track:i6$(m)};
n&&(m.playlistId=n);if(L=g.F(L.actionMetadata,aZp))m.maximumDownloadQuality=L.maximumDownloadQuality;return{musicTrackEntityActionMetadata:m}},DNo=async function(L){var m=g.Dw();
L=faJ(L);const n=g.Bq(q__);try{var C=await g.aw(m,L,n,void 0,{A0:!0})}catch(Z){if(Z instanceof g.dc)throw C=`GetOffline network manager error: ${Z.message}`,xM(C,Z),Error(C);xM("GetOffline fetch request error",Z);throw Error("GetOffline fetch request error");}m=C.errorMetadata?.status;if(!C)throw xM("Network request failed"),Error("Network request failed");if(m!==void 0)te(m);else if(!C.videos||!C.videos.length)throw xM("No data"),Error("No data");return C.videos.map(Z=>Z.offlineVideoData)},fE=async function(L){var m=
g.Dw();
L=U4p(L);const n=g.Bq(q__);try{var C=await g.aw(m,L,n,void 0,{A0:!0})}catch(Z){if(Z instanceof g.dc)throw C=`GetOffline network manager error for playlist: ${Z.message}`,xM(C,Z),Error(C);xM("GetOffline fetch request error for playlist",Z);throw Error("GetOffline fetch request error for playlist");}m=C.errorMetadata?.status;if(!C)throw xM("Network request failed for playlist"),Error("Network request failed for playlist");if(m!==void 0)te(m,"playlist");else if(!C.playlists||!C.playlists.length)throw xM("No data for playlist"),
Error("No data for playlist");return C.playlists.map(Z=>Z.offlinePlaylistData)},lZJ=async function(L,m,n,C){const Z=await r4();
if(!Z)return[];var z=[];C?.length?z=C:z=await uG(Z,"mainPlaylistEntity");if(!z.length)return[];C=[];const v=Date.now()/1E3;for(const T of z){var E=T.downloadState?await F5(Z,T.downloadState,"mainPlaylistDownloadStateEntity"):void 0,X=(z=T?.entityMetadata)&&z.nextAutoRefreshIntervalSeconds?Number(z.nextAutoRefreshIntervalSeconds):NaN;X=Number.isNaN(X)?L:X;var N=E?.lastSyncedTimestampMillis?Number(E?.lastSyncedTimestampMillis)/1E3:0;E=E?.addedTimestampMillis?Number(E?.addedTimestampMillis)/1E3:0;if(n||
!z||N+X<=v){X=[];if(T.videos?.length)for(const V of T.videos)N=JSON.parse(g.XW(V).entityId),N.videoId&&X.push(N.videoId);N="0";z&&(N=String(Number(z.offlineLastModifiedTimestampSeconds??0).toFixed()));C.push({playlistId:T.playlistId,videoIds:X,offlineLastModifiedTimestamp:N,autoSync:m,offlineDateAddedTimestamp:String(E.toFixed())})}}return C.length?await O6p(C):[]},R30=async function(){var L=await r4();
if(!L)return!1;L=await uG(L,"refresh");if(!L[0]?.refreshTime)return!1;L=Number(L[0].refreshTime);const m=Date.now()/1E3;return isFinite(L)&&m>=L},e3H=async function(L,m){let n;
try{const C=await wTp(L,m);await Z6w(C);n=v8z(C)}catch(C){xM("getAndProcessSmartDownloadsResponse request or processing error",C)}return n},g8Z=async function(L,m,n,C){const Z=await r4();
if(!Z)return[];var z=[];C?.length?z=C:z=await uG(Z,"musicPlaylist");if(!z.length)return[];C=[];const v=Date.now()/1E3;for(const N of z){var E=(z=N?.entityMetadata)&&z.nextAutoRefreshIntervalSeconds?Number(z.nextAutoRefreshIntervalSeconds):NaN;const T=Number.isNaN(E)?L:E;let V=E=0;var X="DOWNLOAD_SYNC_STATE_UNKNOWN";N.downloadMetadata&&(X=await F5(Z,N.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),E=Number(X?.addedTimestampMillis??"0")/1E3,V=Number(X?.lastModifiedTimestampMillis??"0")/1E3,
X=X?.syncState??"DOWNLOAD_SYNC_STATE_UNKNOWN");if(n||X!=="DOWNLOAD_SYNC_STATE_UP_TO_DATE"||!z||Number(z.lastSyncedTimestampSeconds??0)+T<=v){z=[];if(N.tracks?.length)for(const a of N.tracks)z.push(g.XW(a).entityId);C.push({playlistId:N.playlistId,videoIds:z,offlineLastModifiedTimestamp:String(V.toFixed()),autoSync:m,offlineDateAddedTimestamp:String(E.toFixed())})}}return C.length?await O6p(C):[]},wTp=async function(L,m){var n=g.Dw(),C=await r4();
let Z;C&&(Z=await FJr(C));C=Z;L={context:g.fI(),browseId:"FEdownloads",browseRequestSupportedMetadata:{downloadsBrowseParams:{offlineFeatureSettingState:{isSdEnabled:L},offlineClientState:C,clientStateRequestData:{preferredFormatType:m}}}};m=g.Bq(MHz);try{var z=await g.aw(n,L,m,void 0,{A0:!0})}catch(v){if(v instanceof g.dc)throw z=`DPS network manager error for smart downloads: ${v.message}`,xM(z,v),Error(z);xM("DPS fetch request error for smart downloads",v);throw Error("DPS fetch request error for smart downloads");
}n=z.errorMetadata?.status;if(z)n!==void 0&&te(n,"smart downloads");else throw xM("Network request failed for smart downloads"),Error("Network request failed for smart downloads");return z},IZ0=async function(L,m){var n=g.Dw();
L={context:g.fI(),videoPlaybackPositionEntities:L,lastSyncTimestampUsec:m};m=g.Bq(S_z);try{var C=await g.aw(n,L,m,void 0,{A0:!0})}catch(Z){if(Z instanceof g.dc)throw C=`VPPS network manager error: ${Z.message}`,xM(C,Z),Error(C);xM("VPPS fetch request error",Z);throw Error("VPPS fetch request error");}n=C.errorMetadata?.status;if(C)n!==void 0&&te(n,"position sync");else throw xM("Network request failed for position sync"),Error("Network request failed for position sync");return C},AFz=async function(L,
m,n){var C=g.Dw(),Z=n.refreshData,z=n.isEnqueuedForExpiredStreamUrlRefetch,v=n.qE,E=n.offlineSourceData;
n=n.mediaCapabilities;L={entityKey:L};Z&&(L.refreshData=Z);z&&(L.isExpiredStreamUrlRefetch=z);v&&(L.downloadParameters=v);E&&(L.offlineSourceData=E);m={context:g.UZ(m),signatureTimestamp:20340,videos:[L]};n&&(m.mediaCapabilities=n);Z=g.Bq(JFz);try{var X=await g.aw(C,m,Z,void 0,{A0:!0})}catch(N){if(N instanceof g.dc)throw X=`GetPDE network manager error: ${N.message}`,xM(X,N),Error(X);xM("GetPDE fetch request error",N);throw Error("GetPDE fetch request error");}C=X.errorMetadata?.status;if(X)C!==void 0&&
te(C,"PDE");else throw xM("Network request failed for PDE"),Error("Network request failed for PDE");return X},te=function(L,m){m=m?` for ${m}`:"";
if(L===0)throw L=`Empty response body${m}`,xM(L),Error(L);L=`Response with error${m}`;xM(L);throw Error(L);},O6p=async function(L){var m=g.Dw();
L=Br$(L);const n=g.Bq(b6z);try{var C=await g.aw(m,L,n,void 0,{A0:!0})}catch(Z){if(Z instanceof g.dc)throw C=`offlinePlaylistSyncCheck network manager error: ${Z.message}`,xM(C,Z),Error(C);xM("offlinePlaylistSyncCheck fetch request error",Z);throw Error("offlinePlaylistSyncCheck fetch request error");}m=C.errorMetadata?.status;if(!C)throw xM("Network request failed for playlist sync"),Error("Network request failed for playlist sync");if(m!==void 0)te(m,"playlist sync");else if(!C.offlinePlaylistSyncCheckDatas||
!C.offlinePlaylistSyncCheckDatas.length)throw xM("No data for playlist sync"),Error("No data for playlist sync");return C.offlinePlaylistSyncCheckDatas.map(Z=>Z.offlinePlaylistSyncCheckData)},tH$=async function(L,m){const n=new Map;
for(const C of m)n.set(C,await L.O(C));return n},UN=function(L,m,n,C,Z,z){m=g.N6(m,n);
return{actionType:L,entityKey:m,actionMetadata:{...z,priority:C,retryScheduleIntervalsInSeconds:Z}}},BE0=async function(L,m){var n=m.entityKey;
const C=g.F(m.actionMetadata,Bw)?.isEnqueuedForExpiredStreamUrlRefetch;try{let z=void 0;z=await fZ0(L,m);let v;try{{const E=g.F(m.actionMetadata,Bw);var Z=E?{maximumDownloadQuality:E.maximumDownloadQuality}:void 0}v=await AFz(n,L.X,{isEnqueuedForExpiredStreamUrlRefetch:C,qE:Z,offlineSourceData:z})}catch(E){const X=LE(m)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";xM("PDE handleAdd error");return Pw(m,!1,void 0,
"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",X,"DOWNLOAD_STATE_FAILED")}await UN$(L,v,m);return Pw(m,!0,v.orchestrationActions)}catch(z){return L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",z instanceof g.NX&&z.type==="QUOTA_EXCEEDED"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),xM("PDE handleAdd error"),Pw(m,!1,void 0,L,n,"DOWNLOAD_STATE_FAILED")}},
Qgl=async function(L,m){const n=m.entityKey,C=g.XW(n).entityId;
var Z=await sa(L.W,{mode:"readonly",HD:!0},V=>{const a=Jv(V,n,"playbackData"),D=Jv(V,g.N6(C,"offlineVideoPolicy"),"offlineVideoPolicy");V=Jv(V,g.N6(C,"transfer"),"transfer");return g.ah.all([a,D,V])});
const [z,v,E]=Z;if(!z||!v)return Pw(m,!0);Z=[];var X=z?.playerResponseJson?JSON.parse(z.playerResponseJson):null;if(E&&X&&L.X.N("html5_refresh_deprecated_downloads")){var N=Pu1(L,X,E);Z=await sgr(L,E)}Z={lastPlayerResponseTimestampSeconds:z.playerResponseTimestamp,offlineToken:v.offlineToken,formatIds:Z};X={};E?.maximumDownloadQuality&&(X.maximumDownloadQuality=E.maximumDownloadQuality);try{let V=void 0;V=await fZ0(L,m);try{var T=await AFz(n,L.X,{refreshData:Z,qE:X,offlineSourceData:V,mediaCapabilities:N})}catch(a){const D=
LE(m)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";xM("PDE handleRefresh error");return Pw(m,!1,void 0,"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",D,"DOWNLOAD_STATE_FAILED")}await UN$(L,T,m);return Pw(m,!0,T.orchestrationActions)}catch(V){return L="PDE handleRefresh error",V instanceof Error&&(L=`PDE handleRefresh error: ${V.message}`),N="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",T="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",
V instanceof g.NX&&V.type==="QUOTA_EXCEEDED"&&(N="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",T="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),xM(L),Pw(m,!1,void 0,N,T,"DOWNLOAD_STATE_FAILED")}},fZ0=async function(L,m){m=g.XW(m.entityKey).entityId;
m=g.N6(m,"videoDownloadContextEntity");L=await F5(L.W,m,"videoDownloadContextEntity");return L?.offlineModeType?{offlineModeType:L.offlineModeType}:void 0},Pw=function(L,m,n,C,Z,z){return new sN(m?"OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS":"OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",LE(L),n,C,Z,z)},UN$=async function(L,m,n){if(m.frameworkUpdates&&g.F(m.frameworkUpdates,R2)){if(g.F(m.frameworkUpdates,R2).mutations&&g.F(m.frameworkUpdates,R2).mutations.length>0&&g.F(m.frameworkUpdates,R2).mutations[0].type===
"ENTITY_MUTATION_TYPE_DELETE"){const C=g.XW(g.F(m.frameworkUpdates,R2).mutations[0].entityKey).entityId,Z=await gk(L.W,C),z=g.F(n.actionMetadata,Bw)?.playlistId;
z&&(Z.playlistId=z);Z.offlineDeleteReason="OFFLINE_DELETE_REASON_UNKNOWN";g.dM(L.X)?await Ds(C,L.W,n,L.J,Z):g.ls(L.X)&&await M0(C,L.W,n,L.J)}await kM(g.F(m.frameworkUpdates,R2))}},Pu1=function(L,m,n){m=N0(L.X,n.cotn,m);
n=g.mo(m);return g.Gb_(m,n,L.X)},sgr=async function(L,m){const n=[];
if(L=await sa(L.W,{mode:"readonly",HD:!0},C=>{const Z=[],z=m.offlineVideoStreams;if(z)for(const v of z)Z.push(Jv(C,v,"offlineVideoStreams"));return g.ah.all(Z)}))for(const C of L)if(C?.streamsProgress){L=C.streamsProgress;
for(let Z=0;Z<L.length;Z++){const z=JSON.parse(L[Z].formatStreamBytes);n.push({itag:z.itag,lmt:z.lastModified,xtags:z.xtags})}}return n},pT$=async function(L,m){m=LE(m);
L=await uG(L.W,"videoPlaybackPositionEntity");if(L.length===0)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);try{const n=await QV.getInstance();if(!n)throw Error("prefStorage is undefined");const C=(await n.get("psi"))?.XY??"0",Z=await IZ0(L,C),z={isPaused:Z.watchHistoryPaused,XY:Z.syncTimestampUsec};await n.set("psi",z);if(!z.isPaused){const v=g.F(Z.frameworkUpdates,R2);Z.frameworkUpdates&&v&&await kM(v)}}catch(n){return xM("PPE handleRefresh error: "+(n instanceof Error?n.message:
"unknown error")),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)},uYp=async function(L,m){const n=LE(m),C=g.XW(m.entityKey).entityId;
try{const Z=await QV.getInstance();if(!Z)throw Error("prefStorage is undefined");const z=await Z.get("psi"),v=g.F(m.actionMetadata,F5J);if(z?.isPaused===!1&&v?.lastPlaybackPositionSeconds){const E={key:g.N6(C,"videoPlaybackPositionEntity"),videoId:C,lastPlaybackPositionSeconds:v.lastPlaybackPositionSeconds};await Qo(L.W,E,"videoPlaybackPositionEntity")}}catch(Z){return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
n)},h3w=async function(L,m){const n=LE(m);
try{const C=g.XW(m.entityKey).entityId;if(C==="!*$_ALL_ENTITIES_!*$")await Om_(L.W);else{const Z=g.N6(C,"videoPlaybackPositionEntity");await po(L.W,Z)}}catch(C){return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},pE=async function(L){return ty_(L)},rFF=async function(L){return(await g.Acm(L)).filter(m=>!!m.url).map(m=>
m.url)},Fz=function(L,m){var n=g.My(m);
if(n===1||n===0)return Promise.resolve();(n=L.player?.getVideoData().videoId===m?L.player:null)&&n.stopVideo();L.J=0;return pE(m)},u1=function(L,m,n=!1,C=!0){m=typeof m==="string"?m:m.videoDetails.videoId;
if(g.My(m)===2){var Z=L.player?.getVideoData().videoId===m?L.player:null;Z&&Z.stopVideo();g.ST(m,2);L.J=2;n?kzJ(L.W):C&&H6F(L.W)}},W5o=async function(L,m){const n=LE(m);
if(await F5(L.W,m.entityKey,"transfer"))return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);try{await Y_H(L,m)}catch(C){return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},Gz$=async function(L,m){const n=LE(m),C=await F5(L.W,m.entityKey,"transfer");
if(!C||C.transferState!=="TRANSFER_STATE_COMPLETE")return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);try{await Y_H(L,m,!0)}catch(Z){return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},dN$=async function(L,m){const n=LE(m),C=g.XW(m.entityKey).entityId,Z=await sa(L.W,{mode:"readonly",
HD:!0},E=>{const X=Jv(E,m.entityKey,"transfer");E=Jv(E,g.N6(C,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.ah.all([X,E])}),[z,
v]=Z;if(!z||z.transferState!=="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH")return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);try{z.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE";await Qo(L.W,z,"transfer");const E=g.XW(z.key).entityId;cs({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_PLAYER_RESPONSE_REFRESH"},{videoId:E,QZ:z,offlineModeType:v?.offlineModeType})}catch(E){return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},Y_H=async function(L,m,n=!1){const C=g.F(m.actionMetadata,K5Z),Z=g.XW(m.entityKey).entityId,z=g.N6(Z,"downloadStatusEntity");
var v=await sa(L.W,{mode:"readonly",HD:!0},T=>{const V=Jv(T,z,"downloadStatusEntity");T=Jv(T,g.N6(Z,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.ah.all([V,T])});
const [E,X]=v;v="TRANSFER_STATE_TRANSFER_IN_QUEUE";E?.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&(v="TRANSFER_STATE_PAUSED_BY_USER");const N={key:m.entityKey,transferState:v,cotn:g.dN(16),enqueuedTimestampMs:Date.now().toString(),maximumDownloadQuality:C?.maximumDownloadQuality,preferredAudioTrack:C?.preferredAudioTrack,transferRetryCount:0,isRefresh:n,hasLoggedFirstStarted:!1};await sa(L.W,{mode:"readwrite",HD:!0},T=>{const V=[];n&&V.push(Bs(T,g.N6(Z,"offlineVideoStreams")));V.push(fo(T,N,"transfer"));
return g.ah.all(V)});
n&&await pE(Z);cs({transferStatusType:"TRANSFER_STATUS_TYPE_ENQUEUED",statusType:"ADDED_TO_QUEUE"},{videoId:Z,QZ:N,offlineModeType:X?.offlineModeType})},yFz=function(L,m,n,C){if(!L.action.entityKey)throw Error("entityKey is missing.");
const {ZT:Z,entityId:z}=g.XW(L.action.entityKey),v={entityType:Z,entityId:z,offlineOrchestrationActionType:L.action.actionType,orchestrationAction:{orchestrationActionId:L.actionId}};m&&(v.offlineOrchestrationActionResult=m.status,v.isRetryable=n?!1:m.W,m.J&&(v.offlineOrchestrationFailureReason=xNF(m.J,v.isRetryable)));L.action.actionMetadata?.offlineLoggingData?.offlineModeType&&(v.offlineModeType=L.action.actionMetadata.offlineLoggingData.offlineModeType);C&&(v.additionalOrchestrationActions=C.map(E=>
({orchestrationActionId:E.actionId})));
return v},xNF=function(L,m){return L!=="OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR"||m?L==="OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"&&m?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":L:"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"},he=function(L,m){const n={offlineOrchestrationContext:yFz(L)};
m=QLJ(m,n);p00(sL0(),m,L.rootActionId)},rk=function(L,m,n,C=[]){m={offlineOrchestrationContext:yFz(L,m,n,C)};
m=QLJ(3,m);p00(sL0(),m,L.rootActionId)},jg$=function(L,m){for(const n of m)he(n,1),L.actions.push(n);
L.actions.sort(L.W)},o8p=function(L,m){if(m)for(let n=0;n<L.actions.length;n++)if(m==="!*$_ALL_ENTITIES_!*$"&&L.actions[n].actionId!==m||m!=="!*$_ALL_ENTITIES_!*$"&&L.actions[n].rootActionId===m&&L.actions[n].actionId!==m)L.actions.splice(n,1),n--},cFz=function(L,m){for(const n of L.actions)if(n.actionId===m)return!0;
return!1},Cc$=async function(L,m,n,C,Z){L=new Lk1(L,m,n,C,Z);
await mQD(L);nkH(L);return L},mQD=async function(L){const m=await uG(L.O,"offlineOrchestrationActionWrapperEntity");
await k$(L,m)},nkH=function(L){const m=L.W.actions[0];
return L.G?(m?.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&L.G[0].action.actionType!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(L.L=!0),Promise.resolve()):ZlJ(L)},ZlJ=async function(L){if(L.G)throw Error("Already processing an action");
if(!L.To()){var m=L.W.actions.shift();GB0(L.wd,!m);if(m!==void 0){m.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&m.actionId==="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS"&&o8p(L.W,m.actionId);var n="";m.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&m.rootActionId===m.actionId&&(n=m.actionId);var C=[m];L.G=C;if(m=L.Wv[m.entityType]){for(const Z of C)he(Z,2);try{const Z=await tH$(m,C.map(z=>z.action));
for(const z of C){const v=Z.get(z.action);await zQD(L,z,v)}o8p(L.W,n)}catch(Z){xM("Orchestration error",Z);try{await vkr(L,C)}catch(z){xM("Orchestration retry error",z);for(const v of C)v.retryScheduleIndex<3&&jg$(L.W,[v])}}finally{L.G=void 0}}else L.G=void 0;await ZlJ(L)}}},zQD=async function(L,m,n){var C=m.retryScheduleIndex+2===3;
if(n.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS"){var Z=void 0;try{Z=n.G?.map(z=>L.createAction(z,m))}catch(z){rk(m,n,C);
yo(L.S,{entityKey:m.action.entityKey,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_UNSUPPORTED_ENTITY_FAILED"});xM("Orchestration subactions creation error",z);return}rk(m,n,C,Z);if(Z){const z=Z.map(E=>$$(E));
let v=0;for(;v<Z.length&&!L.L;)await sa(L.O,{mode:"readwrite",HD:!0},E=>{const X=[];X.push(Ua(E,z.slice(v,v+10),"offlineOrchestrationActionWrapperEntity"));return g.ah.all(X)}),v+=10;
if(L.L){L.L=!1;return}}n=$$(m);await po(L.O,n.key);he(m,4)}else if(n.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE")if(rk(m,n,C),n.W&&m.retryScheduleIndex+1<3)await vkr(L,[m]);else{C={entityKey:m.action.entityKey,failureReason:n?.O?n.O:"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN"};Z=void 0;g.dM(L.X)?Z="mainVideoDownloadStateEntity":g.ls(L.X)&&(Z="musicTrackDownloadMetadataEntity");if(Z&&n.downloadState){const z=g.XW(m.action.entityKey).entityId;await Zs(z,Z,L.O,n.downloadState)}yo(L.S,C);n.downloadState===
"DOWNLOAD_STATE_FAILED"&&L.X.N("html5_auto_retry_failed_pde_actions")||(xM("Orchestration result is not retryable, deleting action"),await po(L.O,$$(m).key))}},vkr=async function(L,m){for(const n of m){const C=n.action?.actionMetadata?.retryScheduleIntervalsInSeconds||[1,
2,4];let Z=1;n.retryScheduleIndex<C.length&&(Z=C[n.retryScheduleIndex]);n.W=Z*1E3+Date.now();n.retryScheduleIndex++}await EkF(L,m)},XAf=async function(L,m){return(await uG(L.O,"offlineOrchestrationActionWrapperEntity",m)).filter(Myp)},k$=async function(L,m){let n=[];
var C=Infinity;let Z=4E3;for(const v of m){m=Number(v.enqueueTimeSec);const E=NdD(m);var z=v.retryScheduleIndex;z=z!=null&&z>0;E>0&&z?(C=Math.min(C,m),Z=Math.min(E,Z)):n.push(v)}isFinite(C)&&(!L.J.isActive()||C<L.T)&&(L.T=C,L.J.start(Z));L.U.Lh()||(C=n.length,n=n.filter(v=>!Tdw.includes(v.actionProto?.actionType||"OFFLINE_ORCHESTRATION_ACTION_TYPE_UNKNOWN")),C=n.length<C,!L.J.isActive()&&C&&L.J.start(1));
n.length>0&&VQz(L,n);await nkH(L)},NdD=function(L){L=L*1E3-Date.now();
return L>4E3?4E3:L},VQz=function(L,m){m.length!==0&&m.forEach(n=>{n=i1(n);
n.retryScheduleIndex<3&&jg$(L.W,[n])})},ilJ=async function(L){var m=await XAf(L);
const n=[];for(const C of m)m=g.XW(C.key).entityId,cFz(L.W,m)||n.push(C);await k$(L,n)},EkF=function(L,m){if(m.length===0)return Promise.resolve([]);
m=m.map(n=>$$(n));
return D4J(L.O,m)},$Qp=async function(L,m){const n=m.videoId;
let C=!0;if(m.captionTracks.length){const Z=opZ(m);L.W=new g.JG(L.Bv,m,Z)}else if(m.fY)L.W=new g.AG(L.Bv,m.fY,n,g.uWp(m),m.xT,m.eventId),C=m.xT;else return;return new Promise(Z=>{L.W?.S({SW:async()=>{await L.SW(n,C);Z()},
Na:()=>{}})})},amH=async function(L){L=await bm$(L);
return!!L&&L.length>0},qLr=async function(L,m){if(m.length===0)return[];
const n=m.map(Z=>g.N6(Z,"transfer")),C=(await uG(L.W,"transfer",n)).filter(Myp).map(Z=>g.XW(Z.key).entityId);
L=m.filter(Z=>C.indexOf(Z)===-1);
if(L.length===0)return[];for(const Z of L)await pE(Z);return L},lmZ=async function(L,m,n,C,Z,z){let v="STREAM_TYPE_UNKNOWN";
n.video&&n.audio?(v="STREAM_TYPE_AUDIO_AND_VIDEO",xM("unexpected stream type")):n.video&&!n.audio?v="STREAM_TYPE_VIDEO":!n.video&&n.audio&&(v="STREAM_TYPE_AUDIO");const E=g.N6(m,"offlineVideoStreams"),X={numBytesDownloaded:Z.toFixed(),numTotalBytes:z.toFixed(),streamType:v,streamState:"DOWNLOAD_STREAM_STATE_IN_PROGRESS",formatStreamBytes:JSON.stringify(C),itag:v==="STREAM_TYPE_AUDIO_AND_VIDEO"?Number(n.itag):void 0};await sa(L,{mode:"readwrite",HD:!0},N=>{const T=Jv(N,E,"offlineVideoStreams"),V=Jv(N,
g.N6(m,"transfer"),"transfer");return g.ah.all([T,V]).then(([a,D])=>{if(!D)return Bs(N,E).then(()=>{});
var R=DQf(a);a=Olf(a,C,X,E);const I=fo(N,a,"offlineVideoStreams");DQf(a)>R&&(D.lastProgressTimeMs=Date.now().toString());R=[I];D.offlineVideoStreams||(D.offlineVideoStreams=[]);D.offlineVideoStreams.indexOf(E)===-1&&(D.offlineVideoStreams.push(E),R.push(fo(N,D,"transfer")));return g.ah.all(R)})})},RQZ=async function(L,m){m=g.N6(m,"offlineVideoStreams");
if((m=await F5(L,m,"offlineVideoStreams"))&&m.streamsProgress){for(const n of m.streamsProgress)n.streamState="DOWNLOAD_STREAM_STATE_COMPLETE",n.numTotalBytes!==n.numBytesDownloaded&&(n.numBytesDownloaded=n.numTotalBytes);await Qo(L,m,"offlineVideoStreams")}},Olf=function(L,m,n,C){if(L&&L.streamsProgress){C=L;
a:{m=`${m.itag};${m.xtags}`;var Z=L.streamsProgress;for(let z=0;z<Z.length;z++){const v=JSON.parse(Z[z].formatStreamBytes);if(`${v.itag};${v.xtags}`===m){Z[z]=n;n=Z;break a}}Z.push(n);n=Z}C.streamsProgress=n}else L={key:C,streamsProgress:[n]};return L},DQf=function(L){if(L?.streamsProgress){let m=0;
L=L.streamsProgress;for(let n=0;n<L.length;n++){const C=L[n];isNaN(Number(C.numBytesDownloaded))?xM("stream progress bytes number invalid"):m+=Number(C.numBytesDownloaded)}return m}return 0},kzJ=async function(L){if(L.W){const m=L.W;
L.G.stop();await Hw(L,"TRANSFER_STATE_PAUSED_BY_USER");const n=m?.key?g.XW(m.key).entityId:"";n&&L.J&&await Zs(n,L.J,L.O,"DOWNLOAD_STATE_PAUSED");const C=await Y$(L,n);x4w({videoId:n,QZ:m,offlineModeType:C})}else Ww(L,"onTransferPausedByUser");GM(L);dk(L)},H6F=async function(L){if(L.W){L.G.stop();
await Hw(L,"TRANSFER_STATE_TRANSFER_IN_QUEUE");var m=L.W;(m=m?.key?g.XW(m.key).entityId:"")&&L.J&&await Zs(m,L.J,L.O,"DOWNLOAD_STATE_PAUSED");GM(L)}else Ww(L,"onTransferPausedByNetwork")},KE=async function(L){if(L.W){L.G.start(108E5);
await Hw(L,"TRANSFER_STATE_TRANSFERRING");var m=L.W;(m=m?.key?g.XW(m.key).entityId:"")&&L.J&&await Zs(m,L.J,L.O,"DOWNLOAD_STATE_DOWNLOAD_IN_PROGRESS")}else Ww(L,"onTransferStart")},wAl=async function(L,m,n){if(L.W){L.W.transferState!=="TRANSFER_STATE_TRANSFERRING"&&await KE(L);
var C=Date.now();C-L.zo>1E3&&(L.zo=C,await lmZ(L.O,n.videoId,n.O,n.xq,n.bytesDownloaded,n.W),!L.j||L.j&&C-L.wd>L.SD)&&(L.wd=C,C=await Y$(L,m),KJp({videoId:m,QZ:L.W,offlineModeType:C},n.bytesDownloaded,n.W));L.G.start(108E5)}else Ww(L,`onTransferProgress: ${m}`)},gkf=async function(L){if(L.W){var m=L.W;
L.G.stop();if(m&&L.L){var n=N0(L.api.D(),m.cotn,L.L);await eQw(L,n)}await Hw(L,"TRANSFER_STATE_COMPLETE","DOWNLOAD_STREAM_STATE_COMPLETE");(n=m?.key?g.XW(m.key).entityId:"")&&L.J&&await Zs(n,L.J,L.O,"DOWNLOAD_STATE_COMPLETE");await RQZ(L.O,n);var C=await Y$(L,n);cs({transferStatusType:"TRANSFER_STATUS_TYPE_COMPLETED",statusType:"SUCCESS"},{videoId:n,QZ:m,offlineModeType:C});GM(L);dk(L)}else Ww(L,"onTransferComplete")},MQr=async function(L){await JVr();
L=L.Je;var m=g.gh();m=Object.keys(m);await qLr(L,m)},JnD=async function(L){L=(await uG(L.O,"transfer")).filter(SLw).sort(Iml);
return L.length===0?void 0:L[0]},tQJ=async function(L,m){if(!L.T){L.T=!0;
L.W=m;var n=g.XW(L.W.key).entityId;if(L.W.transferState==="TRANSFER_STATE_TRANSFERRING"){var C=await Y$(L,n);cs({transferStatusType:"TRANSFER_STATUS_TYPE_RESUME_PROCESSING",statusType:"OFFLINING_RETRIED"},{videoId:n,QZ:L.W,offlineModeType:C})}else L.W.transferState!=="TRANSFER_STATE_TRANSFER_IN_QUEUE"||L.W.transferRetryCount||L.W.hasLoggedFirstStarted||(C=await Y$(L,n),L.W.hasLoggedFirstStarted=!0,await Anw(L),KJp({videoId:n,QZ:L.W,offlineModeType:C},void 0,void 0,!0));await KE(L);n=null;try{n=await blz(L,
m),L.L=n}catch(Z){xM("error getting player response",Z,m.cotn);await L.Q1("TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING");return}C=N0(L.api.D(),m.cotn,n);await eQw(L,C);C.N$=await rFF(C.videoId);n=L.S;m=m.maximumDownloadQuality;C.getPlayerResponse();g.ST(C.videoId,2);n.J=2;n.O=!1;n.player?.dispose();n.player=n.api.yN(C);n.player.Zx({localmediachange:n.m2,signatureexpired:n.Er,statechange:n.G},n);n.N("html5_generate_content_po_token")&&n.player.Gf();m=n.h2(m);n.player.OA(g.U6(m,m,!0,"m"),!1);n.player.uw(!1);
L.G.start(108E5)}},GM=function(L){L.W=void 0;
L.L=void 0;L.G.stop()},dk=async function(L,m=!1){if(L.W)throw Error("Already downloading a video");
L.wd=0;L.T=!1;const n=await JnD(L);d4$(L.Zl,!n);n&&L.U.Lh()?(m&&await new Promise(C=>{g.d9(C,1E3)}),await tQJ(L,n)):!n&&L.W&&GM(L)},Y$=async function(L,m){return(await F5(L.O,g.N6(m,"videoDownloadContextEntity"),"videoDownloadContextEntity"))?.offlineModeType??void 0},fmp=async function(L){L.L&&(await Fz(L.S,L.L.videoDetails.videoId),GM(L))},eQw=async function(L,m){try{(m.captionTracks.length||m.fY)&&!await amH(m.videoId)&&await $Qp(L.Mb,m)}catch(n){xM("Caption downloading error",n,m.cotn)}},Anw=
async function(L,m){if(L.W){var n=L.W;
await sa(L.O,{mode:"readwrite",HD:!0},C=>{const Z=[fo(C,n,"transfer")];m&&Z.push(m(C));return g.ah.all(Z)})}},blz=async function(L,m){m=g.XW(m.key).entityId;
m=g.N6(m,"playbackData");L=await F5(L.O,m,"playbackData");if(L?.playerResponseJson)return JSON.parse(L.playerResponseJson);throw Error("No PlayerResponse found");},Hw=async function(L,m,n,C){if(L.W){L.W.transferState=m;
L.W.failureReason=C;try{await Anw(L,Z=>n?Av(Z,"offlineVideoStreams",L.W.offlineVideoStreams).then(z=>{for(const v of z)if(v&&v.streamsProgress)for(const E of v.streamsProgress)E.streamState=n;return Ua(Z,z.filter(v=>!!v),"offlineVideoStreams")}):g.ah.resolve(void 0))}catch(Z){Z instanceof g.NX&&Z.type==="QUOTA_EXCEEDED"&&await L.Q1("TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE")}}else Ww(L,`saveTransferState: ${m}`)},Ww=function(L,m){L.api.kU("woffle",{mcte:m});
xM("missing current transfer entity.")},UQl=function(L){const m=(L.W.transferRetryCount||0)<3;
m&&(L=L.W,L.transferRetryCount=(L.transferRetryCount||0)+1);return m},BdF=async function(L,m="TRANSFER_FAILURE_REASON_UNKNOWN"){L.W||Ww(L,`setTransferToFailed: ${m}`);
var n="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";m==="TRANSFER_FAILURE_REASON_NETWORK"?n="OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED":m==="TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE"&&(n="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED");await Hw(L,"TRANSFER_STATE_FAILED","DOWNLOAD_STREAM_STATE_ERROR_STREAMS_MISSING",m);yo(L.C,{entityKey:L.W?.key,failureReason:n});n=L.W?g.XW(L.W.key).entityId:"";const C=await Y$(L,n);L={videoId:n,QZ:L.W,offlineModeType:C};n={transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_WITH_FAILURE",
statusType:"FAILED"};m&&(n.transferFailureReason=m,n.failureReason=yVF(m));cs(n,L)},SLw=function(L){return x$[L.transferState]!==void 0},Iml=function(L,m){const n=x$[L.transferState],C=x$[m.transferState];
return n!==C?n-C:Number(L.enqueuedTimestampMs)-Number(m.enqueuedTimestampMs)},PcH=async function(L){g.Pv(L.api,"onOrchestrationBecameLeader");
await L.Rf()},pAF=async function(L){const m=await r4();
if(m){L.O=new s3F(m,L.api,L.J,L.W);var n=L.U(m);L.T=await Cc$(m,n,L.J,L.W,L.X);await Q3o(L)}else xM("PES is undefined")},Q3o=async function(L){if(L.O){L.O.W||await dk(L.O);
L.X.N("woffle_enable_main_downloads_library")&&await L.nI();L.X.N("html5_offline_playback_position_sync")&&(await L.zo(),await L.rY(864E5));await L.refreshAllStaleEntities(43200,!0);await L.j();L.X.N("html5_retry_downloads_for_expiration")&&await L.H9();L.wd=g.Kj(()=>{L.refreshAllStaleEntities(43200,!0);L.j()},9E5);
g.dV(g.xf(),()=>L.AN());
var m=await r4();await HmD(m);WJD(L.J)}else xM("transferManager is undefined")},Fkw=async function(){const L=await r4();
if(!L)return[];const m=Date.now()/1E3,n=await uG(L,"offlineVideoPolicy");for(const C of n)C.expirationTimestamp&&Number(C.expirationTimestamp)<m&&(C.action="OFFLINE_VIDEO_POLICY_ACTION_DISABLE",C.offlinePlaybackDisabledReason="OFFLINE_PLAYBACK_DISABLED_REASON_CLIENT_OFFLINE_CONTENT_EXPIRED",await Qo(L,C,"offlineVideoPolicy"));return n.map(C=>C.key)},yV=async function(L,m,n,C,Z){var z=await r4();
if(!z)return[];m=m.map(v=>{var E=g.N6(v,n);E={actionType:C,entityKey:E,actionMetadata:{...TM(),...Z}};C!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&(E.actionMetadata.priority=0);v=new VV(n,v,E);return $$(v)});
z=D4J(z,m);YYH(L.J);return z},uAF=async function(L,m,n,C){const Z=[];
for(const z of m)if(!z.upToDate&&(!n||z.shouldAutoSyncMetadata)&&z.playlistId){m={};switch(C){case "mainPlaylistEntity":m={mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:z.checkInSeconds,autoSync:n}};break;case "musicPlaylist":m={musicPlaylistEntityActionMetadata:{autoSync:n}}}(m=await yV(L,[z.playlistId],C,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",m))&&Z.push(...m)}return Z},hQp=async function(L,m){if(m.length){const n=TM();
g.N5(n,Bw,{isEnqueuedForExpiredStreamUrlRefetch:!0});L.api.kU("qrd",{v:m.length});return yV(L,m,"playbackData","OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",n)}return[]},kRD=async function(L,m){const n=LE(m);
var C=g.XW(m.entityKey).entityId;let Z=[];try{Z=await rnr(L,C),L.X.N("woffle_enable_main_downloads_library")&&Z?.length&&await wk(L.W,[m.entityKey])}catch(v){return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",v instanceof g.NX&&v.type==="QUOTA_EXCEEDED"?(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"):xM("Playlist add error"),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
n,void 0,m,C)}const z=[];L.X.N("html5_offline_prevent_redownload_downloaded_video")&&(Z=await Xz(L.W,"mainVideoEntity",Z));if(Z?.length)for(const v of Z)L=v.offlineVideoData,L?.videoId&&z.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",L.videoId,"mainVideoEntity",Number(m.actionMetadata?.priority||0)+1,jj,o2(m,L,C)));return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,z)},YLw=async function(L,m){const n=LE(m);
var C=m.entityKey,Z=g.XW(C).entityId,z=[],v=!1;Z==="!*$_ALL_ENTITIES_!*$"?(v=!0,z=await uG(L.W,"mainPlaylistEntity")):(C=await F5(L.W,C,"mainPlaylistEntity"))&&z.push(C);if(!z?.length)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);var E=g.F(m.actionMetadata,Hl1);C=E?.nextAutoRefreshIntervalSeconds;const X=E?.autoSync;let N=[],T=!0;E=!0;let V=!1;if(v||X!==!1){try{N=await lZJ(0,!!X,!0,z)}catch(I){I instanceof Error&&I.message==="No data"?Z==="!*$_ALL_ENTITIES_!*$"?await l1(L.W,m,L.J,
"OFFLINE_DELETE_REASON_UNAVAILABLE"):await ON(Z,L.W,m,L.J):I instanceof Error&&I.message==="Empty response body"&&xM(I.message)}if(!N.length||!v&&N[0].playlistId!==Z)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)}if(v){m=[];for(var a of N)a.upToDate||X&&!a.shouldAutoSyncMetadata||!a.playlistId||m.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",a.playlistId,"mainPlaylistEntity",0,jj,{mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:a.checkInSeconds,autoSync:X}}));
return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,m)}N.length&&(a=N[0],V=!!a.upToDate,X&&(T=a.shouldAutoSyncMetadata??!0,E=a.shouldAutoSyncVideos??!0,a.checkInSeconds&&(C=a.checkInSeconds)));if(V||!T)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);a=[];z=z[0];v=z.downloadState?await F5(L.W,z.downloadState,"mainPlaylistDownloadStateEntity"):void 0;v=v?.addedTimestampMillis?String(v.addedTimestampMillis):void 0;try{a=await rnr(L,Z,v,C)}catch(I){if(I instanceof Error&&I.message===
"No data for playlist")await ON(Z,L.W,m,L.J);else if(I instanceof Error&&I.message==="Empty response body for playlist")xM(I.message);else return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",Z="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",I instanceof g.NX&&I.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",Z="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,m,Z)}if(!E)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
n);L=[];C=new Map;if(a?.length)for(var D of a)E=D.offlineVideoData,E?.videoId&&C.set(E.videoId,E);D=new Map;E=[];if(z?.videos?.length)for(var R of z.videos)if(z=JSON.parse(g.XW(R).entityId).videoId)C.has(z)?(D.set(z,C.get(z)),C.delete(z)):E.push(z);R=Number(m.actionMetadata?.priority||0)+1;for(const [I,t]of C.entries())L.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",I,"mainVideoEntity",R,jj,o2(m,t,Z)));for(const [I,t]of D.entries())L.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",I,"mainVideoEntity",
R,jj,o2(m,t,Z)));for(const I of E)L.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",I,"mainVideoEntity",0,jj,{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"},mainVideoEntityActionMetadata:{playlistId:Z}}));return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,L)},WkF=async function(L,m){const n=LE(m);
try{const C=g.XW(m.entityKey).entityId;C==="!*$_ALL_ENTITIES_!*$"?await l1(L.W,m,L.J,m.actionMetadata?.offlineLoggingData?.offlineDeleteReason):(await ON(C,L.W,m,L.J),L.X.N("woffle_enable_main_downloads_library")&&await ej(L.W,m.entityKey))}catch(C){return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
n)},rnr=async function(L,m,n,C){m=await fE([m]);
const {mainPlaylistEntity:Z,Jp:z}=await GR1(L,m[0],n,C);L=mNH(Z,z?.avatar);try{await q0(L)}catch(v){v instanceof Error&&v.message==="Failed to fetch"&&xM(v.message)}return m[0].videos},o2=function(L,m,n){m={offlineVideoData:m,
playlistId:n};if(L=g.F(L.actionMetadata,Hl1))m.maximumDownloadQuality=L.maximumDownloadQuality;return{mainVideoEntityActionMetadata:m}},GR1=async function(L,m,n,C){const Z=Date.now().toString();
n||(n=Z);var z=m.videos;const v=m.playlistId,E=[],X=[];if(z)for(const a of z){z=a.offlineVideoData;if(!z||!z.videoId)throw xM("Invalid offlineVideoData for playlist"),Error("Invalid offlineVideoData for playlist");z=z.videoId;z={id:g.N6(JSON.stringify({videoId:z,playlistId:v}),"mainPlaylistVideoEntity"),video:g.N6(z,"mainVideoEntity")};E.push(z);X.push(z.id)}let N;const T={key:g.N6(v,"mainPlaylistDownloadStateEntity"),addedTimestampMillis:n,lastSyncedTimestampMillis:Z},V={key:g.N6(v,"mainPlaylistEntity"),
playlistId:v,videos:X,title:m.title,thumbnailStyleData:dQz(m),visibility:KkJ(m),downloadState:T.key};m.channel&&(n=m.channel.offlineChannelData,N=xQr(g.N6(v,"ytMainChannelEntity"),n),V.channelOwner=N.id);V?.entityMetadata?(V.entityMetadata.offlineLastModifiedTimestampSeconds=m.lastModifiedTimestamp,C&&(V.entityMetadata.nextAutoRefreshIntervalSeconds=String(C))):V&&(V.entityMetadata={nextAutoRefreshIntervalSeconds:C?String(C):void 0,offlineLastModifiedTimestampSeconds:m.lastModifiedTimestamp});try{await sa(L.W,
{mode:"readwrite",HD:!0},a=>{var D=fo(a,V,"mainPlaylistEntity");const R=fo(a,T,"mainPlaylistDownloadStateEntity");D=[D,R];for(const I of E)D.push(fo(a,I,"mainPlaylistVideoEntity"));N&&D.push(fo(a,N,"ytMainChannelEntity"));return g.ah.all(D)})}catch(a){throw xM("PES failure for playlist"),Error("PES failure for playlist");
}return{mainPlaylistEntity:V,Jp:N,ngK:E}},dQz=function(L){const m=[];
var n=L.videos;n&&n.length>0&&m.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_FIRST_VIDEO"),value:{collageThumbnail:{coverThumbnail:n[0].offlineVideoData.thumbnail}}});if((L=L.additionalMetadadatas)&&L.length>0)for(const C of L)switch(L=C.offlineBundleItemPlaylistData,n={collageThumbnail:{coverThumbnail:L?.coverThumbnail}},L?.style){case "BUNDLE_ITEM_STYLE_UNSPECIFIED":m.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_UNKNOWN"),value:n});break;case "BUNDLE_ITEM_STYLE_TWO_BY_TWO":m.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_TWO_BY_TWO"),
value:n});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO_AVATAR":m.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO_AVATAR"),value:n});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO":m.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO"),value:n})}return m},KkJ=function(L){switch(L.privacy){case "PRIVATE":return"PLAYLIST_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_VISIBILITY_UNLISTED";default:return"PLAYLIST_VISIBILITY_UNKNOWN"}},xQr=function(L,m){return{id:L,
channelId:m.channelId,title:m.title,avatar:m.thumbnail}},ok_=async function(L,m){const n=LE(m);
var C=g.XW(m.entityKey).entityId;const Z=g.F(m.actionMetadata,cw),z=!Z?.playlistId;try{await ynH(L,C,void 0,Z?.offlineVideoData,z)}catch(v){return C="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",m="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",v instanceof g.NX&&v.type==="QUOTA_EXCEEDED"&&(C="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",m="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,C,m)}L=Number(m.actionMetadata?.priority||
0)+1;m=(m=g.F(m.actionMetadata,cw))?{playbackDataActionMetadata:{maximumDownloadQuality:m.maximumDownloadQuality}}:void 0;C=UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",C,"playbackData",L,j3H,m);return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,[C])},cn_=async function(L,m){const n=LE(m),C=g.XW(m.entityKey).entityId;
var Z=await F5(L.W,m.entityKey,"mainVideoEntity"),z=Z?await F5(L.W,Z.downloadState,"mainVideoDownloadStateEntity"):void 0;if(!Z||!z)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);let v;try{await ynH(L,C,z.addedTimestampMillis,g.F(m.actionMetadata,cw)?.offlineVideoData),Z=1,Z=Number(m.actionMetadata?.priority||0)+1,v=UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",C,"playbackData",Z,j3H)}catch(E){if(E instanceof Error&&E.message==="No data"){Z=await gk(L.W,C);if(z=g.F(m.actionMetadata,
cw)?.playlistId)Z.playlistId=z;Z.offlineDeleteReason="OFFLINE_DELETE_REASON_UNAVAILABLE";await Ds(C,L.W,m,L.J,Z)}else if(E instanceof Error&&E.message==="Empty response body")xM(E.message);else return L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",m="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",E instanceof g.NX&&E.type==="QUOTA_EXCEEDED"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",m="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
n,void 0,L,m)}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,v?[v]:void 0)},L6f=async function(L,m){const n=LE(m);
try{const C=g.XW(m.entityKey).entityId;if(C==="!*$_ALL_ENTITIES_!*$")await l1(L.W,m,L.J,m.actionMetadata?.offlineLoggingData?.offlineDeleteReason);else{const Z=await gk(L.W,C),z=g.F(m.actionMetadata,cw)?.playlistId;z&&(Z.playlistId=z);Z.offlineDeleteReason=m.actionMetadata?.offlineLoggingData?.offlineDeleteReason;await Ds(C,L.W,m,L.J,Z);L.X.N("woffle_enable_main_downloads_library")&&await ej(L.W,m.entityKey)}}catch(C){return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},ynH=async function(L,m,n,C,Z){C||(C=(await DNo([m]))[0]);
const {mainVideoEntity:z,channelEntity:v}=await mJ0(L,C,n,Z);try{const E=EN(z.thumbnail),X=EN(v.avatar);await q0(E.concat(X))}catch(E){E instanceof Error&&E.message==="Failed to fetch"&&xM(E.message)}},mJ0=async function(L,m,n,C){n||(n=Date.now().toString());
const Z=m.channel?.offlineChannelData,z={id:g.N6(m.videoId,"ytMainChannelEntity"),channelId:Z.channelId,title:Z.title,avatar:Z.thumbnail},v={key:g.N6(m.videoId,"mainVideoDownloadStateEntity"),playbackData:g.N6(m.videoId,"playbackData"),addedTimestampMillis:n,videoDownloadContextEntity:g.N6(m.videoId,"videoDownloadContextEntity")},E={key:g.N6(m.videoId,"videoPlaybackPositionEntity"),videoId:m.videoId,lastPlaybackPositionSeconds:"0"};let X;L.X.N("html5_offline_playback_position_sync")&&(X={playbackPosition:E.key});
n=g.N6(m.videoId,"mainVideoEntity");const N={key:n,videoId:m.videoId,title:m.title,thumbnail:m.thumbnail,localizedStrings:{viewCount:m.shortViewCountText},userState:X,lengthSeconds:m.lengthSeconds?Number(m.lengthSeconds):void 0,publishedTimestampMillis:m.publishedTimestamp?(Number(m.publishedTimestamp)*1E3).toString():void 0,formattedDescription:m.description,owner:z.id,downloadState:v.key};let T,V;L.X.N("woffle_enable_main_downloads_library")&&C&&(C=await XT_(L.W,[n]))&&(T=C.mainDownloadsLibraryEntity,
V=C.mainDownloadsListEntity);let a;a={key:g.N6(m.videoId,"downloadStatusEntity"),downloadState:"DOWNLOAD_STATE_PENDING_DOWNLOAD"};g.N5(v,oqo,a);await sa(L.W,{mode:"readwrite",HD:!0},D=>{var R=fo(D,z,"ytMainChannelEntity"),I=fo(D,v,"mainVideoDownloadStateEntity");const t=fo(D,N,"mainVideoEntity");R=[R,I,t];L.X.N("html5_offline_playback_position_sync")&&(I=fo(D,E,"videoPlaybackPositionEntity"),R.push(I));T&&(I=fo(D,T,"mainDownloadsLibraryEntity"),R.push(I));V&&(I=fo(D,V,"mainDownloadsListEntity"),R.push(I));
a&&(D=fo(D,a,"downloadStatusEntity"),R.push(D));return g.ah.all(R)});
return{mainVideoEntity:N,channelEntity:z}},CNp=async function(L,m){const n=LE(m),C=[];
var Z=await QV.getInstance();let z,v;Z&&(z=await Z.get("sdois"),v=await Z?.get("lmqf"));try{if(z===void 0)throw Error("prefStorage or opt-in state is undefined");Z=[];z||(Z=await E80(L.W),Z.reverse());if(Z.length)for(const N of Z){if(!N)continue;const T=g.XW(N).entityId,V=await gk(L.W,T);V.offlineDeleteReason="OFFLINE_DELETE_REASON_PARENT_LIST_DELETE";await Ds(T,L.W,{entityKey:N,actionType:m.actionType},L.J,V)}const E=await wTp(z,v??"SD");await Z6w(E);const X=v8z(E);L.X.N("woffle_enable_main_downloads_library")&&
(z||await ej(L.W,g.Kg),await wk(L.W,[g.Kg]));if(X?.length)for(const N of X){const T=N.actionType,V=N.entityKey,a=N.actionMetadata;if(T&&V&&a&&!g.F(a,nRF)){T==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(a.offlineLoggingData={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});const D=g.F(N.actionMetadata,cw);D&&(D.playlistId="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS",N.actionMetadata={...N.actionMetadata,mainVideoEntityActionMetadata:D});C.push(N)}}}catch(E){return L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",
m="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",E instanceof g.NX&&E.type==="QUOTA_EXCEEDED"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",m="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,L,m)}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,C)},ZS0=async function(L,m=43200,n=!0){if(!L.S.Lh())return[];
let C=[];try{C=await lZJ(m,n,!1)}catch(Z){Z instanceof Error&&Z.message==="No data"||Z instanceof Error&&Z.message==="Empty response body"&&xM(Z.message)}return uAF(L,C,n,"mainPlaylistEntity")},z1F=async function(L,m,n,C=!1){let Z=[];
if(!await R30()&&!C)return[];n=await e3H(m,n);if(!n?.length)return[];m={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"};for(const v of n){n=v.actionType;var z=v.entityKey;C=v.actionMetadata;n&&z&&C&&!g.F(C,nRF)&&(n==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(C.offlineLoggingData=m),{entityId:z}=g.XW(z),n=await yV(L,[z],"mainVideoEntity",n,C),Z=Z.concat(n))}return Z},ERD=async function(L,m){const n=LE(m);
var C=g.XW(m.entityKey).entityId;let Z=[];try{Z=await vRr(L,C),Z?.length&&await Je(L.W,m.entityKey)}catch(v){return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",v instanceof g.NX&&v.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,m,C)}const z=[];Z=await Xz(L.W,"musicTrack",Z);if(Z.length)for(const v of Z)L=
v.offlineVideoData,L?.videoId&&z.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",L.videoId,"musicTrack",Number(m.actionMetadata?.priority||0)+1,LL,b1(m,L,C)));return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,z)},XxF=async function(L,m){const n=LE(m);
var C=m.entityKey,Z=g.XW(C).entityId,z=[],v=!1;Z==="!*$_ALL_ENTITIES_!*$"?(v=!0,z=await uG(L.W,"musicAlbumRelease")):(C=await F5(L.W,C,"musicAlbumRelease"))&&z.push(C);if(!z?.length)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);if(v){m=[];for(var E of z){var X=g.XW(E.id).entityId;m.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",X,"musicAlbumRelease",0,LL))}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,m)}E=[];z=z[0];v=void 0;z.downloadMetadata&&(v=await F5(L.W,
z.downloadMetadata,"musicAlbumReleaseDownloadMetadataEntity"),v=Number(v?.addedTimestampMillis??"0")/1E3);try{E=await vRr(L,Z,v?.toString())}catch(V){if(V instanceof Error&&V.message==="No data")await Sj(Z,"musicAlbumRelease",L.W,m,L.J);else if(V instanceof Error&&V.message==="Empty response body")xM(V.message);else return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",X="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",V instanceof g.NX&&V.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
X="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,m,X)}L=[];Z=new Map;if(E?.length)for(var N of E)E=N.offlineVideoData,E?.videoId&&Z.set(E.videoId,E);N=new Map;E=[];if(z?.tracks?.length)for(var T of z.tracks)if(z=g.XW(T).entityId)Z.has(z)?(N.set(z,Z.get(z)),Z.delete(z)):E.push(z);T=Number(m.actionMetadata?.priority||0)+1;for(const [V,a]of Z.entries())L.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",V,"musicTrack",T,LL,b1(m,a)));for(const [V,
a]of N.entries())L.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",V,"musicTrack",T,LL,b1(m,a)));for(X of E)L.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",X,"musicTrack",0,LL));return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,L)},NX$=async function(L,m){const n=LE(m);
try{const C=g.XW(m.entityKey).entityId;C==="!*$_ALL_ENTITIES_!*$"?await I2(L.W,m,L.J):(await Sj(C,"musicAlbumRelease",L.W,m,L.J),await Ae(L.W,m.entityKey))}catch(C){return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},vRr=async function(L,m,n){m=await fE([m]);
L=await TXf(L,m[0],n);L=EN(L.thumbnailDetails);await q0(L);return m[0].videos},TXf=async function(L,m,n){var C=m.additionalMetadadatas;
let Z=void 0;if(C&&C.length>0)for(var z of C)if(z.offlineMusicPlaylistData){Z=z.offlineMusicPlaylistData;break}C=m.playlistId;const {TU:v,Qq:E}=$Nw(m);n=n?(Number(n)*1E3).toString():Date.now().toString();z=m.lastModifiedTimestamp?(Number(m.lastModifiedTimestamp)*1E3).toString():"0";const X={id:g.N6(C,"musicAlbumReleaseDownloadMetadataEntity"),trackDownloadMetadatas:E,lastModifiedTimestampMillis:z,addedTimestampMillis:n,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},N={id:g.N6(C,"musicAlbumRelease"),
title:m.title,audioPlaylistId:C,trackCount:m.totalVideoCount,tracks:v,downloadMetadata:X.id};Z&&(N.thumbnailDetails=Z.albumHqThumbnail??Z.albumArtistThumbnail,N.artistDisplayName=Z.albumArtistDisplayName,N.releaseDate=Z.albumReleaseDate,N.contentRating={explicitType:Z.albumReleaseExplicitType},N.releaseType=Z.albumReleaseType);await sa(L.W,{mode:"readwrite",HD:!0},T=>{const V=fo(T,N,"musicAlbumRelease");T=fo(T,X,"musicAlbumReleaseDownloadMetadataEntity");return g.ah.all([V,T])});
return N},iSJ=async function(L,m){const n=LE(m);
var C=g.XW(m.entityKey).entityId;let Z=[];try{Z=await VX_(L,C),Z?.length&&await Je(L.W,m.entityKey)}catch(v){return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",v instanceof g.NX&&v.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,m,C)}const z=[];Z=await Xz(L.W,"musicTrack",Z);if(Z.length)for(const v of Z)L=
v.offlineVideoData,L?.videoId&&z.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",L.videoId,"musicTrack",Number(m.actionMetadata?.priority||0)+1,ms,b1(m,L,C)));return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,z)},$JJ=async function(L,m){const n=LE(m);
var C=m.entityKey,Z=g.XW(C).entityId,z=[],v=!1;Z==="!*$_ALL_ENTITIES_!*$"?(v=!0,z=await uG(L.W,"musicPlaylist")):(C=await F5(L.W,C,"musicPlaylist"))&&z.push(C);if(!z?.length)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);const E=g.F(m.actionMetadata,aZp)?.autoSync;let X=[],N=!0;C=!0;let T=!1;var V=void 0;if(v||E!==!1){try{X=await g8Z(0,!!E,!0,z)}catch(t){t instanceof Error&&t.message==="No data"?Z==="!*$_ALL_ENTITIES_!*$"?await I2(L.W,m,L.J):await Sj(Z,"musicPlaylist",L.W,m,L.J):t instanceof
Error&&t.message==="Empty response body"&&xM(t.message)}if(!X.length||!v&&X[0].playlistId!==Z)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)}if(v){m=[];for(var a of X)a.upToDate||E&&!a.shouldAutoSyncMetadata||!a.playlistId||m.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",a.playlistId,"musicPlaylist",0,ms,{musicPlaylistEntityActionMetadata:{autoSync:E}}));return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,m)}X.length&&(a=X[0],T=!!a.upToDate,E&&(N=a.shouldAutoSyncMetadata??
!0,C=a.shouldAutoSyncVideos??!0,a.checkInSeconds&&(V=a.checkInSeconds)));if(T||!N)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);a=[];z=z[0];v=void 0;z.downloadMetadata&&(v=await F5(L.W,z.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),v=Number(v?.addedTimestampMillis??"0")/1E3);try{a=await VX_(L,Z,v?.toString(),V)}catch(t){if(t instanceof Error&&t.message==="No data")await Sj(Z,"musicPlaylist",L.W,m,L.J);else if(t instanceof Error&&t.message==="Empty response body")xM(t.message);
else{m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";var D="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED";t instanceof g.NX&&t.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",D="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE");return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,m,D)}}if(!C)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);L=[];Z=new Map;if(a?.length)for(var R of a)C=R.offlineVideoData,C?.videoId&&
Z.set(C.videoId,C);R=new Map;C=[];if(z?.tracks?.length)for(var I of z.tracks)if(V=g.XW(I).entityId)Z.has(V)?(R.set(V,Z.get(V)),Z.delete(V)):C.push(V);I=Number(m.actionMetadata?.priority||0)+1;for(const [t,f]of Z.entries())L.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",t,"musicTrack",I,ms,b1(m,f)));for(const [t,f]of R.entries())L.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",t,"musicTrack",I,ms,b1(m,f)));for(D of C)L.push(UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",D,"musicTrack",0,ms));
return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,L)},aYp=async function(L,m){const n=LE(m);
try{const C=g.XW(m.entityKey).entityId;C==="!*$_ALL_ENTITIES_!*$"?await I2(L.W,m,L.J):(await Sj(C,"musicPlaylist",L.W,m,L.J),await Ae(L.W,m.entityKey))}catch(C){return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},VX_=async function(L,m,n,C){m=await fE([m]);
L=await qp1(L,m[0],n,C);L=EN(L.thumbnailDetails);await q0(L);return m[0].videos},qp1=async function(L,m,n,C){const Z=m.playlistId,{TU:z,
Qq:v}=$Nw(m);n=n?(Number(n)*1E3).toString():Date.now().toString();const E=m.lastModifiedTimestamp?(Number(m.lastModifiedTimestamp)*1E3).toString():"0",X={id:g.N6(Z,"musicPlaylistDownloadMetadataEntity"),trackDownloadMetadatas:v,lastModifiedTimestampMillis:E,addedTimestampMillis:n,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},N={id:g.N6(Z,"musicPlaylist"),title:m.title,playlistId:Z,thumbnailDetails:m.thumbnail,visibility:DJr(m),trackCount:m.totalVideoCount,tracks:z,downloadMetadata:X.id};C&&(N?.entityMetadata?
N.entityMetadata.nextAutoRefreshIntervalSeconds=String(C):N&&(N.entityMetadata={nextAutoRefreshIntervalSeconds:String(C)}));await sa(L.W,{mode:"readwrite",HD:!0},T=>{const V=fo(T,N,"musicPlaylist");T=fo(T,X,"musicPlaylistDownloadMetadataEntity");return g.ah.all([V,T])});
return N},DJr=function(L){switch(L.privacy){case "PRIVATE":return"PLAYLIST_ENTITY_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_ENTITY_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_ENTITY_VISIBILITY_UNLISTED";default:return"PLAYLIST_ENTITY_VISIBILITY_UNKNOWN"}},R1z=async function(L,m){const n=LE(m);
var C=g.XW(m.entityKey).entityId;const Z=g.F(m.actionMetadata,nL);try{await OSr(L,C,void 0,Z?.track,Z?.albumRelease),Z?.playlistId||await Je(L.W,m.entityKey)}catch(z){return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",z instanceof g.NX&&z.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,
void 0,m,C)}L=(L=g.F(m.actionMetadata,nL))?{playbackDataActionMetadata:{maximumDownloadQuality:L.maximumDownloadQuality}}:void 0;m=UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",C,"playbackData",Number(m.actionMetadata?.priority||0)+1,lY$,L);return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,[m])},wxz=async function(L,m){const n=LE(m),C=g.XW(m.entityKey).entityId;
var Z=await F5(L.W,m.entityKey,"musicTrack");const z=Z?await F5(L.W,Z.downloadMetadata,"musicTrackDownloadMetadataEntity"):void 0;if(!Z||!z)return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);let v;Z=g.F(m.actionMetadata,nL);try{await OSr(L,C,z.addedTimestampMillis,Z?.track,Z?.albumRelease),v=UN("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",C,"playbackData",Number(m.actionMetadata?.priority||0)+1,lY$)}catch(E){if(E instanceof Error&&E.message==="No data")await M0(C,L.W,m,L.J);else if(E instanceof
Error&&E.message==="Empty response body")xM(E.message);else return L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",m="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",E instanceof g.NX&&E.type==="QUOTA_EXCEEDED"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",m="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,L,m)}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,v?[v]:void 0)},e11=async function(L,
m){const n=LE(m);
try{const C=g.XW(m.entityKey).entityId;C==="!*$_ALL_ENTITIES_!*$"?await I2(L.W,m,L.J):(await M0(C,L.W,m,L.J),await Ae(L.W,m.entityKey))}catch(C){return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new sN("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},OSr=async function(L,m,n,C,Z){C||(C=(await DNo([m]))[0],C=i6$(C));
const {musicTrackEntity:z,nB:v}=await gR0(L,C,m,Z,n);L=EN(z.thumbnailDetails);m=[];v&&(m=EN(v.thumbnailDetails));await q0(L.concat(m))},gR0=async function(L,m,n,C,Z){Z||(Z=Date.now().toString());
const z={id:g.N6(n,"musicTrackDownloadMetadataEntity"),playbackData:g.N6(n,"playbackData"),addedTimestampMillis:Z,videoDownloadContextEntity:g.N6(n,"videoDownloadContextEntity")};C&&(m.albumRelease=C.id);await sa(L.W,{mode:"readwrite",HD:!0},v=>{const E=[];var X=fo(v,z,"musicTrackDownloadMetadataEntity");E.push(X);X=fo(v,m,"musicTrack");E.push(X);C&&(v=fo(v,C,"musicAlbumRelease"),E.push(v));return g.ah.all(E)});
await Zs(n,"musicTrackDownloadMetadataEntity",L.W,"DOWNLOAD_STATE_PENDING_DOWNLOAD");return{musicTrackEntity:m,nB:C}},MXD=async function(L,m=43200,n=!0){if(!L.S.Lh())return[];
let C=[];try{C=await g8Z(m,n,!1)}catch(Z){}return uAF(L,C,n,"musicPlaylist")},Spw=function(L){let m;
L=g.F(L.getWatchNextResponse()?.currentVideoEndpoint,g.uo);L?.playlistId&&(m=L.playlistId);return m},IYJ=async function(L,m){const n=m.clientPlaybackNonce,C={cpn:n,
offlineSourceVisualElement:g.Gu(m.Je||"").getAsJson(),selectedOfflineMode:"OFFLINE_NOW",isPartialPlayback:!1};m.O&&(C.videoFmt=Number(m.O.itag));m.G&&(C.audioFmt=Number(m.G.itag));const Z=Spw(m);var z;if(z=Z&&m.videoId)m=m.videoId,z=await (Z!=="PPSV"?Promise.resolve(!1):L.W.Je(m));z&&(C.selectedOfflineMode="OFFLINE_MODE_TYPE_AUTO_OFFLINE");L.O=n;g.mR("offlinePlaybackStarted",C)};
g.nh.prototype.yN=g.nJ(45,function(L){return this.app.yN(L)});
g.hG.prototype.yN=g.nJ(44,function(L){return g.adF(this,9,L)});
var CL=class{constructor(L){this.W=L}},ZN=class extends CL{get entityMetadata(){return this.W.entityMetadata}set entityMetadata(L){this.W.entityMetadata=L}},JY0=class extends CL{O(){const L=[];this.W.video&&L.push(this.W.video);return[...(new Set(L))]}},AYp=class extends CL{O(){const L=[];this.W.video&&L.push(this.W.video);this.W.playlist&&L.push(this.W.playlist);this.W.videoItem&&L.push(this.W.videoItem);this.W.playlistItem&&L.push(this.W.playlistItem);return[...(new Set(L))]}},bSD=class extends CL{O(){const L=
[];this.W.localImageEntities&&L.push(...this.W.localImageEntities);this.W.videoDownloadContextEntity&&L.push(this.W.videoDownloadContextEntity);return[...(new Set(L))]}},tXZ=class extends CL{O(){const L=[];this.W.recommendedVideoMetadata&&L.push(...(new bSD(this.W.recommendedVideoMetadata)).O());return[...(new Set(L))]}},fY$=class extends CL{O(){const L=[];this.W.playbackPosition&&L.push(this.W.playbackPosition);return[...(new Set(L))]}},UJl=class extends CL{O(){const L=[];this.W.creatorEntity&&L.push(this.W.creatorEntity);
return[...(new Set(L))]}},MHz=["browse","music/browse","unplugged/browse"],b6z=["offline/playlist_sync_check"],q__=["offline"],S_z=["offline/offline_video_playback_position_sync"],JFz=["offline/get_playback_data_entity"],w4,QV=class{constructor(L){this.token=L}static async getInstance(){return new Promise(L=>{g.ht().then(m=>{m?(QV.instance||(QV.instance=new QV(m)),L(QV.instance)):L(void 0)})})}async get(L){if(L=await (await ee(this.token)).get("prefs",L)){var m=(0,g.h)();
return L.expirationTimestampMs<=m?void 0:L.value}}async set(L,m,n=31536E3){const C=(0,g.h)();L={key:L,value:m,expirationTimestampMs:C+n*1E3};m=await ee(this.token);await g.SB(m,"prefs",L)}async remove(L){await (await ee(this.token)).delete("prefs",L)}},BXF={INVALID_ENCODER_VERSION:"Invalid encoder version",KEY_CREATION_FAILED:"Failed to create encoder key",UNKNOWN_DECODE_ERROR:"Failed to decode PES data",UNKNOWN_ENCODE_ERROR:"Failed to encode PES data",WRONG_DATA_TYPE:"Encoder cannot process the data type"},
g4=class extends g.WN{constructor(L,m={}){super(BXF[L],{name:"PESEncoderError",type:L,...m});this.type=L;this.level="WARNING";Object.setPrototypeOf(this,g4.prototype)}},PNZ=class{},sf_=class extends PNZ{constructor(L){super();this.W=L}J(L,m){m=MS(m);L=(new TextEncoder).encode(JSON.stringify(L));return this.W.encrypt(L,m)}O(L,m){if(!(L instanceof Uint8Array))throw new g4("WRONG_DATA_TYPE",{NZ:1});const n=new TextDecoder;m=MS(m);L=this.W.decrypt(L,m);return JSON.parse(n.decode(L))}},Eq$={accountLinkStatusEntity:class extends ZN{O(){return[]}},
booleanEntity:class extends ZN{O(){return[]}},buttonEntity:class extends ZN{O(){return[]}},captionTrack:class extends ZN{O(){return[]}},channelHandle:class extends ZN{O(){return[]}},chipEntity:class extends ZN{O(){return[]}},commerceAcquisitionClientPayloadEntity:class extends ZN{O(){return[]}},commerceCartListEntity:class extends ZN{O(){return[]}},contextNoteFeedEntityPayload:class extends ZN{O(){return[]}},contextNoteUserRatingEntityPayload:class extends ZN{O(){return[]}},continuationTokenEntity:class extends ZN{O(){return[]}},
downloadQualityPickerEntity:class extends ZN{O(){return[]}},downloadsPageRefreshTokenEntity:class extends ZN{O(){return[]}},downloadsPageViewConfigurationEntity:class extends ZN{O(){return[]}},downloadStatusEntity:class extends ZN{O(){return[]}},dismissState:class extends ZN{O(){return[]}},sfvAudioItemCurrentlyPlayingEntity:class extends ZN{O(){return[]}},emojiFountainDataEntity:class extends ZN{O(){return[]}},emojiCustomizationSetEntity:class extends ZN{O(){return[]}},fakeChannel:class extends ZN{O(){const L=
[];this.W.alternateChannel&&L.push(this.W.alternateChannel);this.W.alternateChannelList&&L.push(...this.W.alternateChannelList);this.W.oneofChannelEntity&&L.push(this.W.oneofChannelEntity);return[...(new Set(L))]}},fakePlaylist:class extends ZN{O(){const L=[];this.W.entryCollection&&L.push(this.W.entryCollection);return[...(new Set(L))]}},fakePlaylistEntryCollection:class extends ZN{O(){const L=[];this.W.parentPlaylist&&L.push(this.W.parentPlaylist);if(this.W.entries)for(const m of this.W.entries)L.push(...(new JY0(m)).O());
return[...(new Set(L))]}},fakeVideo:class extends ZN{O(){const L=[];this.W.descriptionEntity&&L.push(this.W.descriptionEntity);this.W.creators&&L.push(...this.W.creators);this.W.theBiggestFan&&L.push(this.W.theBiggestFan);return[...(new Set(L))]}},fakeVideoDescription:class extends ZN{O(){return[]}},featuredProductsEntity:class extends ZN{O(){return[]}},flowStateEntity:class extends ZN{O(){return[]}},iconBadgeEntity:class extends ZN{O(){return[]}},interstitialInteractionStateEntity:class extends ZN{O(){return[]}},
likeButtonAnimationEntity:class extends ZN{O(){return[]}},liveChatPollStateEntity:class extends ZN{O(){return[]}},dataFreshnessEntity:class extends ZN{O(){return[]}},liveViewerLeaderboardChatEntryPointStateEntity:class extends ZN{O(){return[]}},liveViewerLeaderboardPointsEntity:class extends ZN{O(){return[]}},liveReactionsDataEntity:class extends ZN{O(){return[]}},logoEntity:class extends ZN{O(){return[]}},macroMarkerEntity:class extends ZN{O(){return[]}},mainDownloadsLibraryEntity:class extends ZN{O(){const L=
[];this.W.downloadsList&&L.push(this.W.downloadsList);this.W.smartDownloadsList&&L.push(this.W.smartDownloadsList);this.W.recommendedDownloadsList&&L.push(this.W.recommendedDownloadsList);this.W.refresh&&L.push(this.W.refresh);return[...(new Set(L))]}},mainDownloadsListEntity:class extends ZN{O(){const L=[];this.W.refresh&&L.push(this.W.refresh);if(this.W.downloads)for(const m of this.W.downloads)L.push(...(new AYp(m)).O());return[...(new Set(L))]}},mainPlaylistDownloadStateEntity:class extends ZN{O(){const L=
[];this.W.localImageEntities&&L.push(...this.W.localImageEntities);return[...(new Set(L))]}},mainPlaylistEntity:class extends ZN{O(){const L=[];this.W.channelOwner&&L.push(this.W.channelOwner);this.W.videos&&L.push(...this.W.videos);this.W.collaboratorChannels&&L.push(...this.W.collaboratorChannels);this.W.downloadState&&L.push(this.W.downloadState);this.W.refresh&&L.push(this.W.refresh);return[...(new Set(L))]}},mainPlaylistVideoEntity:class extends ZN{O(){const L=[];this.W.video&&L.push(this.W.video);
this.W.channelContributor&&L.push(this.W.channelContributor);return[...(new Set(L))]}},mainVideoDownloadStateEntity:class extends ZN{O(){const L=[];this.W.playbackData&&L.push(this.W.playbackData);this.W.localImageEntities&&L.push(...this.W.localImageEntities);this.W.videoDownloadContextEntity&&L.push(this.W.videoDownloadContextEntity);return[...(new Set(L))]}},mainVideoEntity:class extends ZN{O(){const L=[];this.W.owner&&L.push(this.W.owner);this.W.downloadState&&L.push(this.W.downloadState);this.W.userState&&
L.push(...(new fY$(this.W.userState)).O());this.W.additionalMetadata&&L.push(...(new tXZ(this.W.additionalMetadata)).O());return[...(new Set(L))]}},markersEngagementPanelSyncEntity:class extends ZN{O(){return[]}},markersVisibilityOverrideEntity:class extends ZN{O(){return[]}},musicAlbumReleaseDetail:class extends ZN{O(){const L=[];this.W.albumRelease&&L.push(this.W.albumRelease);this.W.tracks&&L.push(...this.W.tracks);return[...(new Set(L))]}},musicAlbumReleaseDownloadMetadataEntity:class extends ZN{O(){const L=
[];this.W.trackDownloadMetadatas&&L.push(...this.W.trackDownloadMetadatas);return[...(new Set(L))]}},musicAlbumRelease:class extends ZN{O(){const L=[];this.W.musicLibraryStatusEntity&&L.push(this.W.musicLibraryStatusEntity);this.W.primaryArtists&&L.push(...this.W.primaryArtists);this.W.details&&L.push(this.W.details);this.W.userDetails&&L.push(this.W.userDetails);this.W.tracks&&L.push(...this.W.tracks);this.W.share&&L.push(this.W.share);this.W.downloadMetadata&&L.push(this.W.downloadMetadata);this.W.refresh&&
L.push(this.W.refresh);return[...(new Set(L))]}},musicAlbumReleaseUserDetail:class extends ZN{O(){const L=[];this.W.albumRelease&&L.push(this.W.albumRelease);return[...(new Set(L))]}},musicArtistDetail:class extends ZN{O(){const L=[];this.W.parentArtist&&L.push(this.W.parentArtist);return[...(new Set(L))]}},musicArtist:class extends ZN{O(){const L=[];this.W.details&&L.push(this.W.details);this.W.userDetails&&L.push(this.W.userDetails);return[...(new Set(L))]}},musicArtistUserDetail:class extends ZN{O(){const L=
[];this.W.parentArtist&&L.push(this.W.parentArtist);return[...(new Set(L))]}},musicDownloadsLibraryEntity:class extends ZN{O(){const L=[];this.W.downloadedTracks&&L.push(...this.W.downloadedTracks);this.W.smartDownloadedTracks&&L.push(...this.W.smartDownloadedTracks);this.W.downloadedEpisodes&&L.push(...this.W.downloadedEpisodes);this.W.downloadedAlbumReleases&&L.push(...this.W.downloadedAlbumReleases);this.W.smartDownloadedAlbumReleases&&L.push(...this.W.smartDownloadedAlbumReleases);this.W.downloadedPlaylists&&
L.push(...this.W.downloadedPlaylists);this.W.smartDownloadedPlaylists&&L.push(...this.W.smartDownloadedPlaylists);this.W.metadataOnlyTracks&&L.push(...this.W.metadataOnlyTracks);return[...(new Set(L))]}},musicLibraryEdit:class extends ZN{O(){return[]}},musicLibraryStatusEntity:class extends ZN{O(){return[]}},musicPlaylist:class extends ZN{O(){const L=[];this.W.tracks&&L.push(...this.W.tracks);this.W.refresh&&L.push(this.W.refresh);this.W.musicLibraryStatusEntity&&L.push(this.W.musicLibraryStatusEntity);
this.W.details&&L.push(this.W.details);this.W.downloadMetadata&&L.push(this.W.downloadMetadata);this.W.sideloadMetadata&&L.push(this.W.sideloadMetadata);this.W.userDetails&&L.push(this.W.userDetails);this.W.entryCollection&&L.push(this.W.entryCollection);this.W.share&&L.push(this.W.share);this.W.podcastShowAdditionalMetadata&&L.push(...(new UJl(this.W.podcastShowAdditionalMetadata)).O());return[...(new Set(L))]}},musicPlaylistDownloadMetadataEntity:class extends ZN{O(){const L=[];this.W.trackDownloadMetadatas&&
L.push(...this.W.trackDownloadMetadatas);return[...(new Set(L))]}},musicShare:class extends ZN{O(){return[]}},musicTrackDetail:class extends ZN{O(){const L=[];this.W.parentTrack&&L.push(this.W.parentTrack);return[...(new Set(L))]}},musicTrackDownloadMetadataEntity:class extends ZN{O(){const L=[];this.W.playbackData&&L.push(this.W.playbackData);this.W.localImageEntities&&L.push(...this.W.localImageEntities);this.W.videoDownloadContextEntity&&L.push(this.W.videoDownloadContextEntity);return[...(new Set(L))]}},
musicTrack:class extends ZN{O(){const L=[];this.W.musicLibraryStatusEntity&&L.push(this.W.musicLibraryStatusEntity);this.W.artists&&L.push(...this.W.artists);this.W.audioModeVersion&&L.push(this.W.audioModeVersion);this.W.videoModeVersion&&L.push(this.W.videoModeVersion);this.W.userDetails&&L.push(this.W.userDetails);this.W.details&&L.push(this.W.details);this.W.albumRelease&&L.push(this.W.albumRelease);this.W.share&&L.push(this.W.share);this.W.libraryEdit&&L.push(this.W.libraryEdit);this.W.downloadMetadata&&
L.push(this.W.downloadMetadata);this.W.playbackPosition&&L.push(this.W.playbackPosition);this.W.lyrics&&L.push(this.W.lyrics);return[...(new Set(L))]}},musicTrackUserDetail:class extends ZN{O(){const L=[];this.W.parentTrack&&L.push(this.W.parentTrack);return[...(new Set(L))]}},offlineOrchestrationActionWrapperEntity:class extends ZN{O(){return[]}},offlineVideoPolicy:class extends ZN{O(){return[]}},offlineVideoStreams:class extends ZN{O(){return[]}},offlineabilityEntity:class extends ZN{O(){return[]}},
orchestrationWebSamplingEntity:class extends ZN{O(){const L=[];this.W.fakeChildren&&L.push(...this.W.fakeChildren);return[...(new Set(L))]}},pageHeaderEntity:class extends ZN{O(){return[]}},pdpStateEntity:class extends ZN{O(){return[]}},pinnedProductEntity:class extends ZN{O(){return[]}},playbackData:class extends ZN{O(){const L=[];this.W.transfer&&L.push(this.W.transfer);this.W.adsPlaybackData&&L.push(...this.W.adsPlaybackData);this.W.drmLicense&&L.push(this.W.drmLicense);this.W.offlineVideoPolicy&&
L.push(this.W.offlineVideoPolicy);this.W.videoDownloadContextEntity&&L.push(this.W.videoDownloadContextEntity);return[...(new Set(L))]}},playerStateEntity:class extends ZN{O(){return[]}},quantityIncrementerEntity:class extends ZN{O(){return[]}},refresh:class extends ZN{O(){return[]}},saveToPlaylistListEntity:class extends ZN{O(){return[]}},selectedChipIndexEntityPayload:class extends ZN{O(){return[]}},settingEntity:class extends ZN{O(){return[]}},stringEntity:class extends ZN{O(){return[]}},suggestedFeedbackChipStateEntity:class extends ZN{O(){return[]}},
transfer:class extends ZN{O(){const L=[];this.W.offlineVideoStreams&&L.push(...this.W.offlineVideoStreams);this.W.captionTrack&&L.push(...this.W.captionTrack);return[...(new Set(L))]}},trendingOfferEntity:class extends ZN{O(){return[]}},videoDownloadContextEntity:class extends ZN{O(){return[]}},videoOverviewAsyncDataEntity:class extends ZN{O(){return[]}},videoPlaybackPositionEntity:class extends ZN{O(){return[]}},votingEntity:class extends ZN{O(){return[]}},ytMainChannelEntity:class extends ZN{O(){const L=
[];this.W.userChannelDetails&&L.push(this.W.userChannelDetails);return[...(new Set(L))]}},youchatPendingResponseEntity:class extends ZN{O(){return[]}},ytMainDownloadedVideoEntity:class extends ZN{O(){const L=[];this.W.video&&L.push(this.W.video);this.W.playbackData&&L.push(this.W.playbackData);this.W.offlineVideoPolicy&&L.push(this.W.offlineVideoPolicy);return[...(new Set(L))]}},ytMainVideoEntity:class extends ZN{O(){const L=[];this.W.channelOwner&&L.push(this.W.channelOwner);this.W.playbackPosition&&
L.push(this.W.playbackPosition);this.W.localImageEntities&&L.push(...this.W.localImageEntities);this.W.downloadStatus&&L.push(this.W.downloadStatus);return[...(new Set(L))]}}},qYD=class{constructor(L,m){this.W=L;this.O=m;this.J={}}},Qfo=class extends PNZ{J(L){return L}O(L){if(L instanceof Uint8Array)throw new g4("WRONG_DATA_TYPE",{NZ:0});return L}},laD=class{constructor(){this.W={};this.W[0]=new Qfo;if(!g.or("aes_pes_encoder_killswitch")){var L=this.W;try{const C=g.HN();var m=MS(C);var n=new sf_(new g.$B(m),
new g.DS(m))}catch(C){throw L=C instanceof Error?new g4("KEY_CREATION_FAILED",{originalMessage:C.message}):new g4("KEY_CREATION_FAILED"),g.CP(L),L;}L[1]=n}}},ROo=class extends g.S_{constructor(L,m){super();this.token=L;this.W=m;this.observers=[];L=new g.X8.BroadcastChannel(`${"PERSISTENT_ENTITY_STORE_SYNC"}:${g.HN()}`);L.onmessage=this.O.bind(this);this.channel=L}observe(L){this.observers.push(L);return()=>{const m=this.observers.indexOf(L);m>=0&&this.observers.splice(m,1)}}O(L){aap(this,L.data)}b1(){this.channel.close()}},
hv,z3F=new g.Es("elementsCommand");var R2=new g.Es("entityBatchUpdate");var oqo=new g.Es("downloadStatusEntity");var Hl1=new g.Es("mainPlaylistEntityActionMetadata");var cw=new g.Es("mainVideoEntityActionMetadata");var aZp=new g.Es("musicPlaylistEntityActionMetadata");var nL=new g.Es("musicTrackEntityActionMetadata");var nRF=new g.Es("localImageEntityActionMetadata");var Bw=new g.Es("playbackDataActionMetadata");var K5Z=new g.Es("transferEntityActionMetadata");var F5J=new g.Es("videoPlaybackPositionEntityActionMetadata");var PF$=class{constructor(){this.W=new Map}},Hs;new g.lz;new g.lz;var uEr=class{constructor(){this.locks=navigator.locks}request(L,m={},n){return this.locks.request(L,m,C=>n(C))}};var G_=g.X8.caches,Ws,d4,pxl=class{open(L){return G_.open(YM(L))}has(L){return G_.has(YM(L))}delete(L){return G_.delete(YM(L))}async match(L,m){var n=await this.keys();for(const C of n)if(n=await (await this.open(C)).match(L,m))return n}},kB$=class extends pxl{async keys(){const L=[],m=g.HN("CacheStorage keys");var n=await G_.keys();for(const C of n){n=C.indexOf(":");const {iI:Z,datasyncId:z}=n===-1?{iI:C}:{iI:C.substring(0,n),datasyncId:C.substring(n+1)};z===m&&L.push(Z)}return L}};var F6$=class extends g.S_{constructor(L){super();this.api=L;this.Wc={ex1:()=>this.W,
WVd:()=>this.O};
typeof g.X8.BroadcastChannel!=="undefined"&&(this.W=new g.X8.BroadcastChannel(`${"PLAYER_OFFLINE_ERROR_SYNC"}:${g.HN()}`),this.W.onmessage=this.J.bind(this),this.O=new g.X8.BroadcastChannel(`${"PLAYER_OFFLINE_PAUSE_SYNC"}:${g.HN()}`),this.O.onmessage=this.G.bind(this))}J(L){g.Pv(this.api,"onOfflineOperationFailure",L.data)}G(L){this.api.publish("offlinetransferpause",L.data)}b1(){this.W?.close();this.O?.close()}};var uSF=class{constructor(L,m,n){this.T=L;this.j=m;this.visibility=n;this.L=this.S=this.U=this.J=this.W=!1;this.G=new g.ni(()=>{this.DX()});
this.Wc={XP:()=>this.O,
DX:()=>{this.DX()},
Gmd:()=>this.G};
this.visibility.subscribe("visibilitystatechange",()=>{this.E6()})}E6(){this.W&&je(this)}DX(){this.O&&this.O.resolve();
this.J=this.W=!1;this.j()}};var Tdw=["OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"];var VV=class{constructor(L,m,n,C,Z=m,z,v,E,X,N,T){this.entityType=L;this.actionId=m;this.action=n;this.parentActionId=C;this.rootActionId=Z;this.childActionIds=z;this.prereqActionId=v;this.postreqActionIds=E;this.hasChildActionFailed=N;this.retryScheduleIndex=0;this.W=T||Date.now();this.retryScheduleIndex=X||0}};var Cur="captionTrack downloadStatusEntity ytMainChannelEntity mainPlaylistEntity mainPlaylistDownloadStateEntity mainPlaylistVideoEntity mainVideoEntity mainVideoDownloadStateEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity videoPlaybackPositionEntity".split(" ");var VHp="downloadStatusEntity musicAlbumRelease musicDownloadsLibraryEntity musicPlaylist musicTrack musicTrackDownloadMetadataEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity".split(" ");var z8=class{constructor(L){this.W=L}},sN=class{constructor(L,m,n,C,Z,z){this.status=L;this.W=m;this.G=n;this.O=C;this.J=Z;this.downloadState=z}};var h1p=class extends z8{constructor(L,m,n){super(L);this.W=L;this.X=m;this.J=n}O(L){return m0(L)?BE0(this,L):nE(L)?Qgl(this,L):Promise.reject(Error(`Unsupported action type: ${L.actionType}`))}};var rYH=class extends z8{constructor(L,m){super(L);this.W=L;this.X=m}O(L){return nE(L)?pT$(this,L):jLw(L)?uYp(this,L):CE(L)?h3w(this,L):Promise.reject(Error(`Unsupported action type: ${L.actionType}`))}};var kvf=class{constructor(L,m){this.api=L;this.W=m;this.logger=new g.T5("woffle");this.O=!1;this.Wc={h2:this.h2}}async G(L){if(L.state.W(128)){const m=L.state.Sr;L=m?.errorCode;L=L==="net.connect"&&m?.OS===1?"TRANSFER_FAILURE_REASON_NETWORK_LOST":L?.startsWith("net.")?"TRANSFER_FAILURE_REASON_NETWORK":"TRANSFER_FAILURE_REASON_INTERNAL";await this.Q1(this.player.getVideoData().videoId,L)}}async Q1(L,m){this.O||(this.O=!0,m==="TRANSFER_FAILURE_REASON_NETWORK_LOST"?u1(this,L,!1,!0):(await Fz(this,L),
g.ST(L,4),await this.W.Q1(m)))}m2(L){L.status===2?(L.status!==this.J&&(KE(this.W),g.ST(L.videoId,2)),L.hd&&wAl(this.W,L.videoId,L.hd)):L.status===4?(Fz(this,L.videoId),this.Q1(L.videoId,L.N_?"TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":"TRANSFER_FAILURE_REASON_INTERNAL")):L.status===1&&gkf(this.W);this.J=L.status;g.Pv(this.api,"localmediachange",{videoId:L.videoId,status:L.status})}async Er(){if(!this.O){this.O=!0;var L=this.player.getVideoData().videoId;await Fz(this,L);await this.W.Er()}}h2(L){switch(L){case "HD_1080":return"hd1080";
case "HD":return"hd720";case "SD":return"large";case "LD":return"tiny";default:return"hd720"}}N(L){return this.api.D().N(L)}};var HS1=class extends z8{constructor(L,m){super(L);this.W=L;this.X=m}O(L){return m0(L)?W5o(this,L):nE(L)?Gz$(this,L):jLw(L)?dN$(this,L):Promise.reject(Error(`Unsupported action type: ${L.actionType}`))}};var Ypr=class{constructor(){this.actions=[]}W(L,m){let n=L.action.actionMetadata.priority-m.action.actionMetadata.priority;n===0&&(L.W<m.W?n=-1:L.W>m.W&&(n=1));return n}};var Lk1=class extends g.S_{constructor(L,m,n,C,Z){super();this.O=L;this.Wv=m;this.wd=n;this.S=C;this.X=Z;this.W=new Ypr;this.U=new g.qU;this.J=new g.ni(()=>{this.retry()});
this.T=NaN;this.L=!1;this.Wc={Jwb:()=>this.W,
w0:()=>this.U,
iEj:()=>this.J,
retry:()=>this.retry()};
g.J(this,this.J);this.j=this.O.observe(this.C.bind(this))}b1(){this.j&&this.j();super.b1()}createAction(L,m){const n=g.XW(L.entityKey).entityType,C=g.dN(16);return new VV(n,C,L,m.actionId,m.rootActionId)}async C(L){if(!this.To()){var m=L.offlineOrchestrationActionWrapperEntity??new Set;L=[];for(var n of m)({entityId:m}=g.XW(n)),cFz(this.W,m)||L.push(n);n=await XAf(this,L);await k$(this,n)}}async retry(){await ilJ(this)}};var W6F=class{constructor(L){this.Bv=L;this.W=void 0}async SW(L,m=!0){if(this.W){var n=[],C=g.lx(this.W.O,m),Z=[];for(let z=0;z<C.length;z++)m=this.W.L(C[z],"json3"),m=g.i2(m,{withCredentials:!0,format:"RAW"},3,500).then(v=>{v={metadata:g.Tr(C[z]),trackData:v.xhr.responseText};Z.push(v)}).uS(v=>{xM("Caption fetch error",v)}),n.push(m);
await chJ(n);try{await AV0(L,Z)}catch(z){xM("Caption DB transaction error",z)}}}};var GvZ=class extends g.S_{constructor(L){super();this.W=L;this.O=this.W.observe(this.J.bind(this))}b1(){this.O&&this.O();super.b1()}async J(L){var m=L.transfer??new Set;L=[];for(const n of m)({entityId:m}=g.XW(n)),L.push(m);L.length!==0&&await qLr(this,L)}};var s3F=class extends g.S_{constructor(L,m,n,C){super();this.O=L;this.api=m;this.Zl=n;this.C=C;this.U=new g.qU;this.G=new g.ni(()=>{this.W&&this.W.transferState==="TRANSFER_STATE_TRANSFERRING"&&this.U.Lh()&&((this.W.transferRetryCount||0)<3?u1(this.S,this.L,!1,!1):Fz(this.S,this.L.videoDetails.videoId),this.Q1("TRANSFER_FAILURE_REASON_TIMEOUT_NO_PROGRESS"))});
this.wd=this.zo=0;this.j=this.T=!1;this.SD=g.JE(this.api.D().experiments,"html5_transfer_processing_logs_interval");this.xU=new g.X7(this);this.Wc={UXv:()=>this.G,
u8o:()=>this.C,
w0:()=>this.U};
this.Wv=this.O.observe(this.m3.bind(this));this.S=new kvf(m,this);this.Mb=new W6F(m);this.Je=new GvZ(this.O);this.KI=this.U.listen("publicytnetworkstatus-online",this.VR.bind(this));this.nI=this.U.listen("publicytnetworkstatus-offline",this.l1.bind(this));this.j=this.api.D().N("html5_less_transfer_processing_logs");g.J(this,this.xU);this.xU.A(m,"offlinetransferpause",this.fI);if(g.dM(this.api.D()))this.J="mainVideoDownloadStateEntity";else if(g.ls(this.api.D())||g.xV(this.api.D()))this.J="musicTrackDownloadMetadataEntity"}b1(){this.Wv&&
this.Wv();this.Je.dispose();this.G.dispose();this.KI&&g.ly(this.U.oY,this.KI);this.nI&&g.ly(this.U.oY,this.nI);super.b1()}async fI(L){const m=g.N6(L,"transfer");if(this.W&&m===this.W.key)u1(this.S,this.L,!0),this.G.stop();else{const n=await sa(this.O,{mode:"readwrite",HD:!0},C=>Jv(C,m,"transfer").then(Z=>{if(Z&&Z.transferState!=="TRANSFER_STATE_COMPLETE"&&Z.transferState!=="TRANSFER_STATE_FAILED")return Z.transferState="TRANSFER_STATE_PAUSED_BY_USER",fo(C,Z,"transfer").then(()=>Z)}));
if(n){L&&this.J&&await Zs(L,this.J,this.O,"DOWNLOAD_STATE_PAUSED");const C=await Y$(this,L);x4w({videoId:L,QZ:n,offlineModeType:C})}}}l1(){if(this.W&&this.L){u1(this.S,this.L,!1);const L=this.W,m=L?.key?g.XW(L.key).entityId:"";m&&this.J&&(new Promise((n,C)=>{Zs(m,this.J,this.O,"DOWNLOAD_STATE_PAUSED").catch(Z=>{C(Z)})})).catch(n=>{xM("Download state setting error",n)})}this.G.stop()}VR(){this.W?tQJ(this,this.W):dk(this)}async m3(L){if(this.W&&(this.W.transferState!=="TRANSFER_STATE_COMPLETE"&&this.W.transferState!==
"TRANSFER_STATE_FAILED"&&L.transfer&&L.transfer.has(this.W.key)&&((this.W=await F5(this.O,this.W.key,"transfer"))||await fmp(this)),this.W))return;
await dk(this)}async Q1(L,m){if(this.W){var n=this.W;const Z=n?.key?g.XW(n.key).entityId:"";a:switch(L){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_PLAYABILITY":case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":var C=!1;break a;default:C=!0}C&&UQl(this)?(await Hw(this,"TRANSFER_STATE_TRANSFER_IN_QUEUE"),L=await Y$(this,Z),cs({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_RETRY"},{videoId:Z,QZ:n,offlineModeType:L}),
Z&&this.J&&await Zs(Z,this.J,this.O,"DOWNLOAD_STATE_RETRYABLE_FAILURE")):(await BdF(this,L),Z&&this.J&&await Zs(Z,this.J,this.O,"DOWNLOAD_STATE_FAILED"))}else Ww(this,`onTransferFailure: ${L}`);GM(this);n=dk(this,!0);m&&m(n)}async Er(L){if(this.W)if(UQl(this)){await Hw(this,"TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH");this.W||Ww(this,"onMaybeTransferStreamsExpiredRetryAttempting");var m=this.W,n=m?.key?g.XW(m.key).entityId:"",C=await Y$(this,n);cs({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_PLAYER_RESPONSE_EXPIRATION"},
{videoId:n,QZ:m,offlineModeType:C});m=TM();g.N5(m,Bw,{isEnqueuedForExpiredStreamUrlRefetch:!0});C=g.N6(n,"playbackData");n=$$(new VV("playbackData",n,{actionType:"OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",entityKey:C,actionMetadata:m}));await Qo(this.O,n,"offlineOrchestrationActionWrapperEntity")}else await BdF(this,"TRANSFER_FAILURE_REASON_STREAM_MISSING"),this.J&&(n=this.W,(n=n?.key?g.XW(n.key).entityId:"")&&await Zs(n,this.J,this.O,"DOWNLOAD_STATE_FAILED"));else Ww(this,"onMaybeTransferStreamsExpired");
GM(this);n=dk(this,!0);L&&L(n)}},x$={TRANSFER_STATE_TRANSFERRING:1,TRANSFER_STATE_TRANSFER_IN_QUEUE:2};var dJZ=class{constructor(L,m){this.X=L;this.api=m;this.S=new g.qU;this.L=new g.lz;this.Wc={XP:()=>this.J.Wc.XP(),
w0:()=>this.S,
Iio:()=>this.J,
hD:()=>this.hD(),
Rf:()=>this.Rf(),
Ut:()=>this.Ut(),
AN:()=>this.AN(),
H9:()=>this.H9(),
rY:n=>this.rY(n)};
this.J=new uSF(()=>PcH(this),()=>{this.Ut()},this.api.Ak(),this.api.N.bind(this.api));
this.W=new F6$(this.api);YYH(this.J)}hD(){return this.L.promise}Rf(){if(this.O&&this.T)return this.L.promise;pAF(this).then(this.L.resolve).catch(this.L.reject);return this.L.promise}U(L){return{playbackData:new h1p(L,this.X,this.W),transfer:new HS1(L,this.X),videoPlaybackPositionEntity:new rYH(L,this.X)}}async AN(){this.O&&await MQr(this.O)}async Ut(){if(this.O||this.T)await this.hD(),this.wd!==void 0&&(g.y3(this.wd),this.wd=void 0),this.G!==void 0&&(g.y3(this.G),this.G=void 0),this.O?.dispose(),
this.O=void 0,this.T?.dispose(),this.T=void 0,g.Pv(this.api,"onOrchestrationLostLeader"),this.L=new g.lz}isOrchestrationLeader(){return this.J.W}async Je(){return!1}zG(L){var m=this.W;m.api.publish("offlinetransferpause",L);m.O?.postMessage(L)}async VR(L){const m=await r4();if(m){var n=g.N6(L,"transfer");await sa(m,{mode:"readwrite",HD:!0},C=>{const Z=Jv(C,n,"transfer"),z=Jv(C,g.N6(L,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.ah.all([Z,z]).then(([v,E])=>v&&v.transferState===
"TRANSFER_STATE_PAUSED_BY_USER"?(v.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE",fo(C,v,"transfer").then(()=>{cs({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_USER_RESUME",statusType:"USER_RESUMED"},{videoId:L,QZ:v,offlineModeType:E?.offlineModeType});return g.ah.resolve(null)})):g.ah.resolve(null))})}}async Wv(L=43200){if(!this.S.Lh())return Fkw();
var m=await r4();if(!m)return[];const n=Date.now()/1E3;var C=await uG(m,"offlineVideoPolicy");m=[];for(const Z of C)Number(Z.lastUpdatedTimestampSeconds)+L<=n&&(C=g.XW(Z.key).entityId,m.push(C));return m.length?yV(this,m,this.C,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"):[]}deleteAll(){return yV(this,["!*$_ALL_ENTITIES_!*$"],this.C,"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}})}async refreshAllStaleEntities(L){return await this.Wv(L)}setUpPositionSyncInterval(L){this.G!==
void 0&&(g.y3(this.G),this.G=void 0);const m=L??864E5;this.G=g.Kj(()=>{this.rY(m)},m)}async rY(L){try{const m=await QV.getInstance();
if(!m)throw Error("prefStorage is undefined");const n=await m.get("psi"),C=n?.XY?Number(n.XY)/1E3:0,Z=Date.now();C+L<=Z&&await yV(this,["!*$_ALL_ENTITIES_!*$"],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH")}catch(m){xM("Offline manager error",m)}}async H9(){var L=await r4();if(!L)return[];var m=await uG(L,"transfer");L=[];for(const n of m)n.transferState==="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH"&&n.key&&(m=g.XW(n.key).entityId,L.push(m));return hQp(this,L)}async j(){return[]}async nI(){}async zo(){}};var K6$=class extends z8{constructor(L,m,n){super(L);this.W=L;this.X=m;this.J=n}O(L){return m0(L)?kRD(this,L):nE(L)?YLw(this,L):CE(L)?WkF(this,L):Promise.reject(Error(`Unsupported action type: ${L.actionType}`))}},jj=[10];var xJ0=class extends z8{constructor(L,m,n){super(L);this.W=L;this.X=m;this.J=n}O(L){return m0(L)?ok_(this,L):nE(L)?cn_(this,L):CE(L)?L6f(this,L):Promise.reject(Error(`Unsupported action type: ${L.actionType}`))}},j3H=[10];var yYo=class extends z8{constructor(L,m,n){super(L);this.W=L;this.X=m;this.J=n}O(L){return nE(L)?CNp(this,L):Promise.reject(Error(`Unsupported action type: ${L.actionType}`))}};var jfr=class extends dJZ{constructor(){super(...arguments);this.C="mainVideoEntity"}U(L){const m=super.U(L);m.mainVideoEntity=new xJ0(L,this.X,this.W);m.mainPlaylistEntity=new K6$(L,this.X,this.W);m.mainDownloadsListEntity=new yYo(L,this.X,this.W);return m}async refreshAllStaleEntities(L,m){let n=[];this.X.N("web_player_offline_playlist_auto_refresh")&&(n=await ZS0(this,L,m));var C=await QV.getInstance();const Z=await C?.get("sdois");C=await C?.get("lmqf");Z&&(n=n.concat(await z1F(this,Z,C??"SD",
L===0)));return n=n.concat(await super.refreshAllStaleEntities(L,m))}async Je(L){var m=await r4();if(!m)return!1;m=await F5(m,g.Kg,"mainDownloadsListEntity");if(m?.downloads?.length){L=g.N6(L,"mainVideoEntity");for(const n of m.downloads)if(n.videoItem===L)return!0}return!1}async j(){var L=await r4();if(!L)return[];var m=await uG(L,"downloadStatusEntity");L=[];for(const n of m)n.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&n.key&&(m=g.XW(n.key).entityId,L.push(m));return L.length?yV(this,L,"mainVideoEntity",
"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}}):[]}async zo(){const L=await r4();L&&await sa(L,{mode:"readwrite",HD:!0},m=>Av(m,"mainVideoEntity").then(n=>{const C=[];for(const Z of n)Z.userState?.playbackPosition||(n=g.XW(Z.key).entityId,n={key:g.N6(n,"videoPlaybackPositionEntity"),videoId:n,lastPlaybackPositionSeconds:"0"},C.push(fo(m,n,"videoPlaybackPositionEntity")),Z.userState={playbackPosition:n.key},C.push(fo(m,Z,
"mainVideoEntity")));return g.ah.all(C)}))}async nI(){const L=await r4();
if(L){var m=g.N6("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),n=await sa(L,{mode:"readonly",HD:!0},V=>g.ah.all([Jv(V,m,"mainDownloadsListEntity"),Jv(V,g.Kg,"mainDownloadsListEntity"),Av(V,"mainVideoEntity"),Av(V,"mainPlaylistEntity")])),[C,
Z,z,v]=n;n=new Set;if(C?.downloads?.length)for(var E of C.downloads){var X=E.videoItem??E.playlistItem;X&&n.add(X)}if(Z?.downloads?.length)for(var N of Z.downloads)N.videoItem&&n.add(N.videoItem);E=new Set;N=[];for(var T of v){if(T.videos)for(const V of T.videos)(X=JSON.parse(g.XW(V).entityId).videoId)&&E.add(X);T.key&&!n.has(T.key)&&N.push(T.key)}for(const V of z)V.key&&!n.has(V.key)&&(T=g.XW(V.key).entityId,E.has(T)||N.push(V.key));N.length&&await wk(L,N)}}};var oRF=class extends z8{constructor(L,m){super(L);this.W=L;this.J=m}O(L){return m0(L)?ERD(this,L):nE(L)?XxF(this,L):CE(L)?NX$(this,L):Promise.reject(Error(`Unsupported action type: ${L.actionType}`))}},LL=[10];var cYl=class extends z8{constructor(L,m){super(L);this.W=L;this.J=m}O(L){return m0(L)?iSJ(this,L):nE(L)?$JJ(this,L):CE(L)?aYp(this,L):Promise.reject(Error(`Unsupported action type: ${L.actionType}`))}},ms=[10];var Lvf=class extends z8{constructor(L,m){super(L);this.W=L;this.J=m}O(L){return m0(L)?R1z(this,L):nE(L)?wxz(this,L):CE(L)?e11(this,L):Promise.reject(Error(`Unsupported action type: ${L.actionType}`))}},lY$=[10];var mn$=class extends dJZ{constructor(){super(...arguments);this.C="musicTrack"}U(L){const m=super.U(L);m.musicTrack=new Lvf(L,this.W);m.musicPlaylist=new cYl(L,this.W);m.musicAlbumRelease=new oRF(L,this.W);return m}async refreshAllStaleEntities(L,m){let n=await MXD(this,L,m);return n=n.concat(await super.refreshAllStaleEntities(L,m))}};g.pw("offline",class extends g.Sn{constructor(){super(...arguments);this.events=new g.X7(this);this.X=this.player.D();this.Wc={XcZ:()=>this.W,
Yb:()=>this.Yb(),
nz:L=>this.nz(L)}}create(){g.J(this,this.events);
if(g.dM(this.X))this.W=new jfr(this.X,this.player);else if(g.ls(this.X)||g.xV(this.X))this.W=new mn$(this.X,this.player);this.events.A(this.player,"onPlaybackStartExternal",()=>{this.Yb()});
this.events.A(this.player,"videodatachange",()=>{this.Yb()});
this.X.N("html5_offline_playback_position_sync")&&this.events.A(this.player,"presentingplayerstatechange",this.nz)}G6(){return!1}async sb(L,m,n,C){return this.W?yV(this.W,L,m,n,C):Promise.reject()}deleteAll(){return this.W.deleteAll()}Wv(L){return this.W.Wv(L)}refreshAllStaleEntities(L){return this.W.refreshAllStaleEntities(L)}setUpPositionSyncInterval(L){this.W.setUpPositionSyncInterval(L)}zG(L){this.W.zG(L)}VR(L){return this.W.VR(L)}async Yb(){const L=this.player.getVideoData();L.J3()&&Spw(L)&&
this.O!==L.clientPlaybackNonce&&await IYJ(this,L)}async nz(L){var m=this.player.getVideoData();const n=m.e9;if(L.yu(2)||L.yu(512))(L=await r4())?(m=m.videoId,await F5(L,g.N6(m,"mainVideoEntity"),"mainVideoEntity")&&await this.sb([m],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE",{videoPlaybackPositionEntityActionMetadata:{lastPlaybackPositionSeconds:Math.floor(n).toString()}})):xM("PES is undefined")}isOrchestrationLeader(){return this.W.isOrchestrationLeader()}async updateDownloadState(L,
m){const n=await r4();if(n){var {entityType:C,entityId:Z}=g.XW(L);await Zs(Z,C,n,m,!0)}else xM("PES is undefined")}});})(_yt_player);
