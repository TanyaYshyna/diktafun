<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–∞—è ‚Äî –î–∏–∫—Ç–∞–Ω—Ç—ã</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style_color.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/style_index.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- FancyTree -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancytree@2/dist/skin-lion/ui.fancytree.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery.fancytree@2.38.2/dist/jquery.fancytree-all-deps.min.js"></script>

</head>

<body>
    <div class="topbar">
        <div class="topbar">
            <img src="/static/icons/logo.svg" class="logo">
        </div>
        <div class="user-section">
            {% if current_user %} {# ‚Üê current_user —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! #}
            <a href="{{ url_for('user.profile') }}" class="username">
                {{ current_user.username }} {# ‚Üê —Ä–∞–±–æ—Ç–∞–µ—Ç! #}
            </a>
            <button class="streak">üî• {{ current_user.streak_days }} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</button>
            <a href="{{ url_for('user.logout') }}">–í—ã–π—Ç–∏</a>
            {% else %}
            <a href="{{ url_for('user.login') }}">–í–æ–π—Ç–∏</a>
            {% endif %}
        </div>
    </div>

    <div class="panel">
        <h2>–°–ø–∏—Å–æ–∫ –¥–∏–∫—Ç–∞–Ω—Ç–æ–≤</h2>
        <div class="buttons-row">
            <div class="buttons-row-left">
                <div id="header-language-selector"></div>

                <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ -->
                <div class="tooltip-wrapper">
                    <select id="languageFilter">
                        <option value="learning_to_native">–ò–∑—É—á–∞–µ–º—ã–π ‚áí –†–æ–¥–Ω–æ–π</option>
                        <option value="learning_only">–¢–æ–ª—å–∫–æ –∏–∑—É—á–∞–µ–º—ã–π</option>
                        <option value="all">–í—Å–µ —è–∑—ã–∫–∏</option>
                    </select>
                </div>

                <div class="tooltip-wrapper">
                    <button id="btnAddNode">
                        <i data-lucide="trash-2"></i>
                    </button>
                    <!-- <div class="tooltip-text">–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç</div> -->
                </div>
                <div class="tooltip-wrapper">
                    <button id="btnDeleteNode">
                        <i data-lucide="folder-plus"></i>
                    </button>
                    <!-- <div class="tooltip-text">–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</div> -->
                </div>
            </div>
            <div class="buttons-row-left-right">
                <a
                    href="{{ url_for('dictation_generator.dictation_generator', language_original='en', language_translation='ru') }}">
                    <button id="newDictationBtn" title="–°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç">
                        <i data-lucide="file-plus-2"></i>
                    </button>
                </a>
            </div>
        </div>


        <div id="container-tree-cards">
            <div id="leftPanel">

                <div id="treeContainer"></div>
            </div>

            <div id="resizer"></div>

            <div id="rightPanel">
                <div id="text_tree_branch">–≤–µ—Ç–∫–∞ –¥–µ—Ä–µ–≤–∞</div>
                <div id="content">
                    <!-- <div id="dictationList"></div> -->
                    <div id="dictationsGrid" class="shorts-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="language-config" data-language-data='{{ language_data | tojson }}'
        data-native-language="{{ user.native_language }}"
        data-learning-languages='{{ user.learning_languages | tojson }}'
        data-current-learning="{{ user.current_learning }}" style="display: none;">
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        lucide.createIcons();
    </script>
    <!-- –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞ –≤ JavaScript -->
    <script type="application/json" id="categories-data">
    {{ categories_data | tojson | safe }}
    </script>

    <script src="{{ url_for('static', filename='js/user_manager.js') }}"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UserManager
        const UM = new UserManager({
            apiBase: '/user/api',
            fallbackToLocal: false
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                await UM.init();
                console.log('UserManager initialized', UM.currentUser);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                updateUIForAuthState();

                UM.onChange((user) => {
                    updateUIForAuthState();
                    // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—è–µ–º —è–∑—ã–∫–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    if (user) {
                        window.USER_LANGUAGE_DATA = {
                            nativeLanguage: user.native_language || 'ru',
                            learningLanguages: user.learning_languages || ['en'],
                            currentLearning: user.learning_language || 'en'
                        };
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ä–µ–≤–æ —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                        if (window.reloadTreeWithFilter) {
                            reloadTreeWithFilter();
                        }
                    }
                });

            } catch (error) {
                console.error('UserManager init error:', error);
            }
        });

        function updateUIForAuthState() {
            const userSection = document.querySelector('.user-section');
            if (!userSection) return;

            if (UM.isAuthenticated() && UM.currentUser) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                userSection.innerHTML = `
                <div id="header-language-selector"></div>
                <a href="/user/profile" class="username">${UM.currentUser.username}</a>
                <button class="streak">üî• ${UM.currentUser.streak_days || 0} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</button>
                <a href="#" onclick="UM.logout(); return false;">–í—ã–π—Ç–∏</a>
            `;
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≥–æ—Å—Ç—è
                userSection.innerHTML = `
                <a href="/user/login">–í–æ–π—Ç–∏</a>
                <a href="/user/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            `;
            }
        }
    </script>

    <script>
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
        const configElement = document.getElementById('language-config');
        if (configElement) {
            const LANGUAGE_DATA = JSON.parse(configElement.dataset.languageData || '{}');
            const USER_LANGUAGE_DATA = {
                nativeLanguage: configElement.dataset.nativeLanguage || 'ru',
                learningLanguages: JSON.parse(configElement.dataset.learningLanguages || '["en"]'),
                currentLearning: configElement.dataset.currentLearning || 'en'
            };

            // –î–µ–ª–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏
            window.LANGUAGE_DATA = LANGUAGE_DATA;
            window.USER_LANGUAGE_DATA = USER_LANGUAGE_DATA;

            console.log('Language data loaded:', LANGUAGE_DATA);
            console.log('User language settings:', USER_LANGUAGE_DATA);
        } else {
            console.error('Language config element not found');
        }
    </script>

    <script src="{{ url_for('static', filename='js/languageSelector.js') }}"></script>
    <script src="{{ url_for('static', filename='js/script_index.js') }}"></script>
</body>

</html>