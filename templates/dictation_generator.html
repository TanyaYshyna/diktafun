<!DOCTYPE html>
<html>

<head>
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–∏–∫—Ç–∞–Ω—Ç–æ–≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style_color.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/style_dictation_generator.css">
    <link rel="stylesheet" href="/static/css/style_dictation_generator_new.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- FancyTree -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancytree@2/dist/skin-lion/ui.fancytree.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery.fancytree@2.38.2/dist/jquery.fancytree-all-deps.min.js"></script>

    <!-- WaveformCanvas -->
    <link rel="icon" href="data:,"> <!-- –ü—É—Å—Ç–∞—è –∏–∫–æ–Ω–∫–∞ -->
    <script src="{{ url_for('static', filename='js/waveform_canvas.js') }}"></script>
</head>

<body>
    <div class="topbar">
        <!-- <img src="/static/icons/logo.svg" class="logo"> -->
        <img src="/static/icons/logo.svg" class="logo" onclick="window.location.href='/'">
        <div class="user-section" id="user-section">
            <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
            <a href="/user/profile" class="username">
                <span class="user-avatar-small"></span>
                <span class="username-text"></span>
            </a>
            <button class="streak">üî• <span class="streak-days">0</span> –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</button>

        </div>
    </div>

    <div class="panel">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div id="langPair" data-original="{{ original_language }}" data-translation="{{ translation_language }}">
                    {{ original_language }} ‚áí {{ translation_language }}
                </div>
                <h2 id="dictation-id">–ù–æ–≤—ã–π –¥–∏–∫—Ç–∞–Ω—Ç: </h2>
            </div>
            <button id="saveAndExitBtn" class="button-color-green">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∏–∫—Ç–∞–Ω—Ç –∏ –≤—ã–π—Ç–∏</button>
        </div>

        <!-- –®–∞–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å –¥–≤—É–º—è –ø–∞–Ω–µ–ª—è–º–∏ -->
        <div class="editor-header">
            <div class="editor-header-panel-1">
                <div class="cover-section">
                    <div class="cover-display">
                        <img id="coverImage" src="/static/data/covers/cover_{{ original_language }}.webp" alt="Cover" />
                    </div>
                    <div class="cover-upload">
                        <input type="file" id="coverFile" accept="image/*" style="display: none;">
                        <button id="coverUploadBtn" class="button-color-lightgreen">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>
                </div>
            </div>
            <div class="editor-header-panel-2">
                <div class="form-group-line">
                    <label style="color: var(--color-button-text-lightgreen);">{{ original_language }}:</label>
                    <input class="text-input" type="text" id="title" required>
                </div>
                <div class="form-group-line">
                    <label style="color: var(--color-button-text-yellow);">{{ translation_language }}:</label>
                    <input class="text-input" type="text" id="title_translation" required>
                </div>
                <!-- –°–ø–∏–∫–µ—Ä—ã (–æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤) -->
                <div id="speakersDisplay" class="speakers-display" style="display: none;">
                    <label>–°–ø–∏–∫–µ—Ä—ã:</label>
                    <div id="speakersList"></div>
                </div>
            </div>
        </div>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–∫—Ç–∞–Ω—Ç–∞) -->
        <div id="textInputSection">
            <label style="color: var(--color-button-text-yellow);">–¢–µ–∫—Å—Ç –ø–æ —Ñ—Ä–∞–∑–∞–º (/* –ø—Ä–µ–≤–æ–¥):</label>
            <textarea id="text" type="text" rows="10"></textarea>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ "–í–Ω–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –∑–∞–Ω–æ–≤–æ" (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–∫—Ç–∞–Ω—Ç–∞) -->
        <div id="reenterTextSection" style="display: none;">
            <button id="reenterTextBtn" class="button-color-yellow">üîÑ –í–Ω–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –∑–∞–Ω–æ–≤–æ</button>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
        <div class="main-content">
            <table id="sentences-table">
                <thead>
                    <tr>
                        <th class="col-number">‚Ññ</th>
                        <th class="col-speaker" style="display: none;">–°–ø–∏–∫–µ—Ä</th>
                        <th class="col-original">–û—Ä–∏–≥–∏–Ω–∞–ª</th>
                        <th class="col-play-original">‚ñ∂Ô∏è</th>
                        <th class="col-settings-original">‚öôÔ∏è</th>
                        <th class="col-translation">–ü–µ—Ä–µ–≤–æ–¥</th>
                        <th class="col-play-translation">‚ñ∂Ô∏è</th>
                        <th class="col-generate-tts" style="display: none;">–°-—Ç—å</th>
                        <th class="col-checkbox" style="display: none;">‚úîÔ∏è</th>
                        <th class="col-audio-file" style="display: none;">–§–∞–π–ª</th>
                        <th class="col-start" style="display: none;">Start</th>
                        <th class="col-end" style="display: none;">End</th>
                        <th class="col-chain" style="display: none;">üîó</th>
                        <th class="col-create-audio" style="display: none;">–°-—Ç—å</th>
                        <th class="col-play-audio" style="display: none;">‚ñ∂Ô∏è</th>
                        <th class="col-apply" style="display: none;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- –°—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="startModal" class="modal-overlay" style="display: none;">
        <div class="modal-content start-modal">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∫—Ç–∞–Ω—Ç–∞</h2>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="isDialogCheckbox">
                    –≠—Ç–æ –¥–∏–∞–ª–æ–≥
                </label>
            </div>

            <div id="speakersTable" class="speakers-table" style="display: none;">
                <h3>–°–ø–∏–∫–µ—Ä—ã</h3>
                <table id="speakersTableContent">
                    <thead>
                        <tr>
                            <th>‚Ññ</th>
                            <th>–ò–º—è —Å–ø–∏–∫–µ—Ä–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><input type="text" class="speaker-name" value="–°–ø–∏–∫–µ—Ä 1" placeholder="–ò–º—è —Å–ø–∏–∫–µ—Ä–∞"></td>
                            <td><button type="button" class="remove-speaker">–£–¥–∞–ª–∏—Ç—å</button></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td><input type="text" class="speaker-name" value="–°–ø–∏–∫–µ—Ä 2" placeholder="–ò–º—è —Å–ø–∏–∫–µ—Ä–∞"></td>
                            <td><button type="button" class="remove-speaker">–£–¥–∞–ª–∏—Ç—å</button></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" id="addSpeakerBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–ø–∏–∫–µ—Ä–∞</button>
            </div>

            <div class="form-group">
                <label for="translationDelimiter">–°–∏–º–≤–æ–ª –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞:</label>
                <input type="text" id="translationDelimiter" value="/*" placeholder="/*">
            </div>

            <div class="form-group">
                <label for="startTextInput">–¢–µ–∫—Å—Ç –¥–∏–∫—Ç–∞–Ω—Ç–∞:</label>
                <textarea id="startTextInput" rows="10" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–∏–∫—Ç–∞–Ω—Ç–∞..."></textarea>
            </div>

            <div class="modal-buttons">
                <button type="button" id="cancelStartBtn">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" id="createDictationBtn">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∫—Ç–∞–Ω—Ç</button>
            </div>
        </div>
    </div>

    <!-- –†–∞—Å–∫—Ä—ã–≤–∞—é—â–µ–µ—Å—è –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞—É–¥–∏–æ -->
    <div id="audioSettingsModal" class="audio-settings-modal" style="display: none;">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏–æ</h2>
        
        <div class="audio-controls">
            <div class="form-group">
                <label for="audioFilesSelect">–ê—É–¥–∏–æ—Ñ–∞–π–ª—ã:</label>
                <select id="audioFilesSelect">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</option>
                </select>
                <button type="button" id="openFileBtn">–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª</button>
                <button type="button" id="audioToTableBtn">–ê—É–¥–∏–æ –≤ —Ç–∞–±–ª–∏—Ü—É</button>
                <button type="button" id="recordAudioBtn">üé§ –ó–∞–ø–∏—Å–∞—Ç—å</button>
            </div>

            <div class="waveform-container">
                <div id="audioWaveform"></div>
            </div>

            <div class="current-text">
                <p id="currentSentenceText"></p>
            </div>

            <div class="playback-controls">
                <button type="button" id="audioPlayBtn">
                    <i data-lucide="play"></i>
                </button>
                <div class="time-controls">
                    <label for="audioStartTime">Start:</label>
                    <input type="number" id="audioStartTime" step="0.01" min="0">
                    <label for="audioEndTime">End:</label>
                    <input type="number" id="audioEndTime" step="0.01" min="0">
                </div>
                
                <!-- –î—É–±–ª–∏—Ä—É–µ–º –ø–æ–ª—è —Å –∏–º–µ–Ω–∞–º–∏ startTime –∏ endTime –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å JavaScript -->
                <div style="display: none;">
                    <input type="number" id="startTime" step="0.01" min="0">
                    <input type="number" id="endTime" step="0.01" min="0">
                </div>
            </div>
        </div>

        <div class="modal-buttons">
            <button type="button" id="cancelAudioBtn">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" id="applyAudioBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        lucide.createIcons();
    </script>

    <!-- –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç—ã UserManager -->
    <script src="{{ url_for('static', filename='js/language_manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/user_manager.js') }}"></script>

    <script id="init-data" type="application/json">
    {{ {
        "dictation_id": dictation_id,
        "editMode": edit_mode,
        "original_language": original_language,
        "translation_language": translation_language,
        "original_data": original_data,
        "translation_data": translation_data,
        "audio_file": audio_file,
        "title": title,
        "level": level,
        "audio_words": audio_words,
        "safe_email": safe_email
     } | tojson }}
    </script>


    <!-- –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –°–ò–ù–•–†–û–ù–ù–û -->
    <script src="{{ url_for('static', filename='js/script_dictation_generator.js') }}"></script>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UserManager –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
        document.addEventListener('DOMContentLoaded', async function () {
            // console.log('üöÄ –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –¥–∏–∫—Ç–∞–Ω—Ç–∞...');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ LanguageManager –∑–∞–≥—Ä—É–∂–µ–Ω
            // if (window.LanguageManager) {
            //     console.log('‚úÖ LanguageManager –¥–æ—Å—Ç—É–ø–µ–Ω');
            // }

            if (!window.UM) {
                console.warn('‚ö†Ô∏è UserManager –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä');
                window.UM = new UserManager({ apiBase: '/user/api' });
            } else {
                // console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π UserManager');
            }

            try {
                // –¢–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                if (typeof initDictationGenerator === 'function') {
                    initDictationGenerator();
                    // console.log('‚úÖ script_dictation_generator.js –∑–∞–≥—Ä—É–∂–µ–Ω');
                } else {
                    console.error('‚ùå script_dictation.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ');
                }
            } catch (error) {
                console.error('‚ùå JWT initialization error:', error);
                // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä
                if (typeof initDictationGenerator === 'function') {
                    initDictationGenerator();
                }
            }
        });
    </script>
</body>

</html>